<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Optimiseur de Transporteur</title>

    <!-- ‚úÖ TailwindCSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ‚úÖ React 18 (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- ‚úÖ Ic√¥nes Lucide -->
    <script src="https://unpkg.com/lucide-react@0.394.0/dist/lucide-react.umd.js"></script>

    <!-- ‚úÖ Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ‚úÖ Babel (pour ex√©cuter le JSX directement dans le navigateur) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      /********************************************
       *  CONFIGURATION SUPABASE
       ********************************************/
      // üëâ Remplace ces deux variables par les tiennes
      const SUPABASE_URL = "https://eayhqksztfhyxqhrrnkk.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVheWhxa3N6dGZoeXhxaHJybmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTQwMzksImV4cCI6MjA3Nzc3MDAzOX0.AsWKSQDa9MDpsmvP6i4LOwBJevQfzUyImzt2_8D-o18"; // ‚Üê √† remplir

      const OPENROUTESERVICE_API_KEY =
        "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijc0ODM1ZTU2MzJkYjQyOGY4ZGRjNmFhMjYxN2ZhYjM3IiwiaCI6Im11cm11cjY0In0=";

      // ‚úÖ Initialisation s√©curis√©e du client Supabase
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      /********************************************
       *  COMPOSANT PRINCIPAL REACT
       ********************************************/
      const { useState, useEffect, useMemo, useCallback, useRef } = React;
      const lucide =
        window.lucideReact || window.LucideReact || window.lucide || {};

      const createFallbackIcon = (emoji) =>
        function FallbackIcon({ className = "", size = 24 }) {
          return (
            <span
              className={className}
              style={{ fontSize: size, lineHeight: 1 }}
              role="img"
              aria-hidden="true"
            >
              {emoji}
            </span>
          );
        };

      const TruckIcon = lucide.Truck || createFallbackIcon("üöö");
      const CalculatorIcon = lucide.Calculator || createFallbackIcon("üßÆ");
      const SearchIcon = lucide.Search || createFallbackIcon("üîç");
      const RouteIcon = lucide.Route || lucide.Map || createFallbackIcon("üó∫Ô∏è");
      const UnlockIcon = lucide.LockOpen || lucide.LogIn || createFallbackIcon("üîê");
      const LogoutIcon = lucide.LogOut || createFallbackIcon("üö™");
      const SettingsIcon = lucide.Settings || createFallbackIcon("‚öôÔ∏è");
      const UploadIcon = lucide.Upload || createFallbackIcon("üì§");
      const SaveIcon = lucide.Save || createFallbackIcon("üíæ");
      const RefreshIcon = lucide.RefreshCcw || createFallbackIcon("üîÅ");
      const UsersIcon = lucide.Users || createFallbackIcon("üßë‚Äçü§ù‚Äçüßë");
      const TrashIcon =
        lucide.Trash2 || lucide.Trash || createFallbackIcon("üóëÔ∏è");

      const ADMIN_EMAILS = ["admin@users.eloy"];
      const NON_SELECTION_REASONS = [
        "Difficult√© √† joindre le transporteur",
        "D√©lais de livraison propos√©s trop longs",
        "Transporteur inadapt√© √† la zone",
        "Contraintes internes / planning interne incompatible",
        "Pr√©f√©rence pour un autre transporteur (organisation interne)",
      ];

      const sanitizeUsername = (username) => {
        if (!username) return "";

        return username
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-zA-Z0-9._-]+/g, "-")
          .toLowerCase()
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");
      };

      const buildAuthEmailFromUsername = (username) => {
        const sanitized = sanitizeUsername(username);
        if (!sanitized) {
          return "";
        }
        return `${sanitized}@users.eloy`;
      };

      const normalizeDepartmentCode = (value) => {
        if (value === null || value === undefined) {
          return "";
        }
        return String(value).trim().toLowerCase();
      };

      const buildTariffKey = (transporteurId, departementId, departementCode) => {
        if (!transporteurId) return null;
        if (
          departementId !== null &&
          departementId !== undefined &&
          departementId !== ""
        ) {
          return `id:${transporteurId}-${departementId}`;
        }

        const normalizedCode = normalizeDepartmentCode(departementCode);
        if (normalizedCode) {
          return `code:${transporteurId}-${normalizedCode}`;
        }

        return null;
      };

      const parseTariff = (rawCost) => {
        if (rawCost === null || rawCost === undefined) {
          return { available: false };
        }

        if (typeof rawCost === "number") {
          if (!Number.isFinite(rawCost) || rawCost <= 0) {
            return { available: false };
          }
          return { available: true, value: rawCost };
        }

        if (typeof rawCost === "string") {
          const normalized = rawCost.replace(",", ".").trim();
          if (!normalized) {
            return { available: false };
          }
          const numericCost = Number(normalized);
          if (!Number.isFinite(numericCost) || numericCost <= 0) {
            return { available: false };
          }
          return { available: true, value: numericCost };
        }

        return { available: false };
      };

      /********************************************
       *  FONCTION: Calcul d‚Äôun itin√©raire optimal
       *  (d√©partements tri√©s du plus proche au plus √©loign√©)
       ********************************************/
      function calculateOptimalRoute(selectedDeptIds, departments) {
        if (!selectedDeptIds.length) return [];
        const list = selectedDeptIds
          .map((id) => departments.find((d) => d.id === id))
          .filter(Boolean)
          .sort((a, b) => a.km - b.km);
        return list;
      }

      /********************************************
       *  INTERFACE ADMINISTRATEUR
       ********************************************/
      function AdminDashboard({ session, onExit, onDataUpdated }) {
        const [activeTab, setActiveTab] = useState("tarifs");
        const [adminLoading, setAdminLoading] = useState(true);
        const [adminError, setAdminError] = useState("");
        const [adminMessage, setAdminMessage] = useState("");
        const [csvError, setCsvError] = useState("");
        const [isSavingTariffs, setIsSavingTariffs] = useState(false);
        const [isSavingTransporters, setIsSavingTransporters] = useState(false);
        const [isDeletingTransporterId, setIsDeletingTransporterId] =
          useState(null);
        const [isImporting, setIsImporting] = useState(false);
        const [tariffRows, setTariffRows] = useState([]);
        const [expandedTransporters, setExpandedTransporters] = useState([]);
        const [transporterRows, setTransporterRows] = useState([]);
        const [transporterSourceRows, setTransporterSourceRows] = useState([]);
        const [rawDepartments, setRawDepartments] = useState([]);
        const [rawTransporters, setRawTransporters] = useState([]);
        const fileInputRef = useRef(null);

        const normalizeNumber = (value) => {
          if (value === null || value === undefined || value === "") return null;
          const normalized = String(value).replace(",", ".").trim();
          if (!normalized) return null;
          const parsed = Number(normalized);
          if (!Number.isFinite(parsed)) {
            throw new Error(`La valeur "${value}" n'est pas un nombre valide.`);
          }
          return parsed;
        };

        const formatTariffForInput = (value) => {
          if (value === null || value === undefined || value === "") {
            return "";
          }

          try {
            const parsed = normalizeNumber(value);
            if (parsed === null) {
              return "";
            }
            return String(parsed);
          } catch (error) {
            return String(value).trim();
          }
        };

        const loadAdminData = useCallback(async () => {
          try {
            setAdminLoading(true);
            setAdminError("");
            setAdminMessage("");
            setCsvError("");

            const [departmentsResult, transportersResult, tariffsResult] = await Promise.all([
              supabase.from("departements").select("*"),
              supabase.from("transporteurs").select("*"),
              supabase.from("tarifs_transporteurs").select("*"),
            ]);

            if (departmentsResult.error) throw departmentsResult.error;
            if (transportersResult.error) throw transportersResult.error;
            if (tariffsResult.error) throw tariffsResult.error;

            const parseCoordinate = (value) => {
              if (value === null || value === undefined || value === "") {
                return null;
              }
              const numeric = Number(value);
              return Number.isFinite(numeric) ? numeric : null;
            };

            const departments = (departmentsResult.data || []).map((dept) => ({
              id: dept.id,
              code:
                dept.code ||
                dept.departement_code ||
                dept.department_code ||
                dept.code_insee ||
                "",
              name: dept.name || dept.nom || dept.libelle || "",
              km: dept.km ?? dept.distance ?? null,
              latitude:
                parseCoordinate(dept.latitude) ||
                parseCoordinate(dept.lat) ||
                parseCoordinate(dept.lat_dd) ||
                parseCoordinate(dept.coord_latitude) ||
                null,
              longitude:
                parseCoordinate(dept.longitude) ||
                parseCoordinate(dept.lon) ||
                parseCoordinate(dept.lng) ||
                parseCoordinate(dept.long) ||
                parseCoordinate(dept.long_dd) ||
                parseCoordinate(dept.coord_longitude) ||
                null,
            }));

            const transporters = (transportersResult.data || []).map((transporter) => {
              const breakOfChargeRaw =
                transporter.break_of_charge ??
                transporter.has_break_of_charge ??
                transporter.hasBreakOfCharge ??
                false;
              const breakOfChargeCostRaw =
                transporter.break_of_charge_cost ??
                transporter.breakOfChargeCost ??
                transporter.break_cost ??
                null;
              const authorizedKmRaw =
                transporter.km_autorise ??
                transporter.kmAutorise ??
                transporter.km_autorized ??
                transporter.authorized_km ??
                null;
              const kmFeeRaw =
                transporter.frais_km ??
                transporter.fraisKm ??
                transporter.cout_km ??
                transporter.coutKm ??
                null;

              return {
                id: transporter.id,
                name: transporter.nom || transporter.name || transporter.libelle || "",
                hasBreakOfCharge: Boolean(breakOfChargeRaw),
                breakOfChargeCost:
                  breakOfChargeCostRaw !== undefined && breakOfChargeCostRaw !== null
                    ? Number(breakOfChargeCostRaw)
                    : 0,
                authorizedKm:
                  authorizedKmRaw !== undefined && authorizedKmRaw !== null
                    ? Number(authorizedKmRaw)
                    : null,
                kmFee:
                  kmFeeRaw !== undefined && kmFeeRaw !== null
                    ? Number(kmFeeRaw)
                    : null,
              };
            });

            const transporterMap = new Map(
              transporters.map((item) => [item.id, item])
            );
            const departmentMap = new Map(
              departments.map((item) => [item.id, item])
            );
            const departmentCodeMap = new Map(
              departments
                .filter((item) => item.code)
                .map((item) => [
                  normalizeDepartmentCode(item.code),
                  item,
                ])
            );

            const tariffs = (tariffsResult.data || [])
              .map((row) => {
                const transporteurId =
                  row.transporteur_id ?? row.transporter_id ?? row.transporteur ?? null;
                const departementCodeRaw =
                  row.departement_code ?? row.department_code ?? row.code ?? null;
                let departementId =
                  row.departement_id ?? row.department_id ?? row.departement ?? null;

                if (!transporteurId) {
                  return null;
                }
                let transporter = null;
                if (transporteurId !== null && transporteurId !== undefined) {
                  transporter = transporterMap.get(transporteurId) || null;
                }

                let department = null;
                if (departementId !== null && departementId !== undefined) {
                  department = departmentMap.get(departementId) || null;
                }

                if (!department && departementCodeRaw) {
                  const matchedDepartment =
                    departmentCodeMap.get(
                      normalizeDepartmentCode(departementCodeRaw)
                    ) || null;
                  if (matchedDepartment) {
                    department = matchedDepartment;
                    if (
                      departementId === null ||
                      departementId === undefined ||
                      departementId === ""
                    ) {
                      departementId = matchedDepartment.id;
                    }
                  }
                }

                const departmentCodeForSave = (() => {
                  if (department?.code) {
                    return department.code.trim();
                  }
                  if (
                    typeof departementCodeRaw === "string" &&
                    departementCodeRaw.trim()
                  ) {
                    return departementCodeRaw.trim();
                  }
                  if (
                    departementCodeRaw !== null &&
                    departementCodeRaw !== undefined
                  ) {
                    return String(departementCodeRaw).trim();
                  }
                  return "";
                })();

                if (!departementId && !departmentCodeForSave) {
                  return null;
                }

                const transporterName =
                  transporter?.name || `Transporteur #${transporteurId}`;
                const departmentDisplayCode =
                  departmentCodeForSave ||
                  department?.code ||
                  (departementId ? `Dept #${departementId}` : "");
                const departmentName = department?.name || "";

                const rawTarpsCost =
                  row.prix_bache ??
                  row.prix_tarps ??
                  row.tarif_bache ??
                  row.tarif_bache_ht ??
                  "";
                const rawFlatbedCost =
                  row.prix_plateau ??
                  row.prix_flatbed ??
                  row.tarif_plateau ??
                  row.tarif_plateau_ht ??
                  "";

                const formattedTarps = formatTariffForInput(rawTarpsCost);
                const formattedFlatbed = formatTariffForInput(rawFlatbedCost);

                return {
                  transporteurId,
                  departementId:
                    departementId ?? department?.id ?? null,
                  transporterName,
                  departmentCode: departmentDisplayCode || "",
                  departmentCodeForSave: departmentCodeForSave || null,
                  departmentName,
                  tarpsCost: formattedTarps,
                  flatbedCost: formattedFlatbed,
                  originalTarpsCost: formattedTarps,
                  originalFlatbedCost: formattedFlatbed,
                  hasExistingTariff: true,
                };
              })
              .filter(Boolean);

            const existingTariffMap = new Map();
            tariffs.forEach((item) => {
              const keyById = buildTariffKey(
                item.transporteurId,
                item.departementId,
                null
              );
              if (keyById) {
                existingTariffMap.set(keyById, item);
              }

              const keyByCode = buildTariffKey(
                item.transporteurId,
                null,
                item.departmentCodeForSave || item.departmentCode
              );
              if (keyByCode) {
                existingTariffMap.set(keyByCode, item);
              }
            });

            const sortedTransporters = [...transporters].sort((a, b) => {
              const nameA = a.name || `Transporteur #${a.id}`;
              const nameB = b.name || `Transporteur #${b.id}`;
              return nameA.localeCompare(nameB, "fr", { numeric: true });
            });
            const sortedDepartments = [...departments].sort((a, b) => {
              const codeA = a.code || `Dept #${a.id}`;
              const codeB = b.code || `Dept #${b.id}`;
              return codeA.localeCompare(codeB, "fr", { numeric: true });
            });

            const completeTariffs = [];

            sortedTransporters.forEach((transporter) => {
              sortedDepartments.forEach((department) => {
                const keyById = buildTariffKey(
                  transporter.id,
                  department.id,
                  null
                );
                const keyByCode = buildTariffKey(
                  transporter.id,
                  null,
                  department.code
                );
                const existing =
                  existingTariffMap.get(keyById) ||
                  existingTariffMap.get(keyByCode);

                completeTariffs.push({
                  transporteurId: transporter.id,
                  departementId: department.id,
                  transporterName:
                    transporter.name || `Transporteur #${transporter.id}`,
                  departmentCode:
                    existing?.departmentCode ||
                    department.code ||
                    `Dept #${department.id}`,
                  departmentCodeForSave:
                    existing?.departmentCodeForSave ?? department.code ?? null,
                  departmentName: existing?.departmentName || department.name || "",
                  tarpsCost: existing?.tarpsCost ?? "",
                  flatbedCost: existing?.flatbedCost ?? "",
                  originalTarpsCost: existing?.originalTarpsCost ?? "",
                  originalFlatbedCost: existing?.originalFlatbedCost ?? "",
                  hasExistingTariff: Boolean(existing?.hasExistingTariff ?? existing),
                });
              });
            });

            setRawDepartments(departments);
            setRawTransporters(transporters);
            setTariffRows(completeTariffs);
            setTransporterSourceRows(transportersResult.data || []);
            setTransporterRows(
              transporters.map((item) => ({
                id: item.id,
                name: item.name,
                hasBreakOfCharge: item.hasBreakOfCharge,
                breakOfChargeCost: String(
                  item.breakOfChargeCost ?? ""
                ),
                authorizedKm: String(item.authorizedKm ?? ""),
                kmFee: String(item.kmFee ?? ""),
              }))
            );
          } catch (err) {
            console.error("‚ùå Erreur chargement admin :", err);
            setAdminError(
              err.message ||
                "Impossible de charger les donn√©es d'administration."
            );
          } finally {
            setAdminLoading(false);
          }
        }, [session?.user?.id]);

        useEffect(() => {
          loadAdminData();
        }, [loadAdminData]);

        const transporterMap = useMemo(
          () => new Map(rawTransporters.map((item) => [item.id, item])),
          [rawTransporters]
        );

        const departmentMap = useMemo(
          () => new Map(rawDepartments.map((item) => [item.id, item])),
          [rawDepartments]
        );

        const groupedTariffs = useMemo(() => {
          const groups = new Map();

          tariffRows.forEach((row, index) => {
            if (!groups.has(row.transporteurId)) {
              groups.set(row.transporteurId, {
                transporterId: row.transporteurId,
                transporterName:
                  row.transporterName || `Transporteur #${row.transporteurId}`,
                departments: [],
              });
            }

            const group = groups.get(row.transporteurId);
            group.departments.push({ ...row, rowIndex: index });
          });

          return Array.from(groups.values())
            .map((group) => ({
              ...group,
              departments: group.departments.sort((a, b) =>
                (a.departmentCode || "").localeCompare(
                  b.departmentCode || "",
                  "fr",
                  {
                    numeric: true,
                  }
                )
              ),
            }))
            .sort((a, b) =>
              (a.transporterName || "").localeCompare(
                b.transporterName || "",
                "fr",
                {
                  numeric: true,
                }
              )
            );
        }, [tariffRows]);

        useEffect(() => {
          setExpandedTransporters((previous) => {
            const validIds = new Set(
              groupedTariffs.map((group) => group.transporterId)
            );
            const filtered = previous.filter((id) => validIds.has(id));
            if (filtered.length === previous.length) {
              return previous;
            }
            return filtered;
          });
        }, [groupedTariffs]);

        const transporterSourceMap = useMemo(
          () =>
            new Map(
              transporterSourceRows
                .filter((item) => item && item.id !== undefined && item.id !== null)
                .map((item) => [item.id, item])
            ),
          [transporterSourceRows]
        );

        const transporterColumnNames = useMemo(() => {
          const hasColumn = (key) =>
            transporterSourceRows.some((row) =>
              row ? Object.prototype.hasOwnProperty.call(row, key) : false
            );

          const nameKey = hasColumn("nom")
            ? "nom"
            : hasColumn("name")
            ? "name"
            : hasColumn("libelle")
            ? "libelle"
            : "nom";

          const breakFlagKey = hasColumn("break_of_charge")
            ? "break_of_charge"
            : hasColumn("has_break_of_charge")
            ? "has_break_of_charge"
            : hasColumn("hasBreakOfCharge")
            ? "hasBreakOfCharge"
            : "break_of_charge";

          const breakCostKey = hasColumn("break_of_charge_cost")
            ? "break_of_charge_cost"
            : hasColumn("break_cost")
            ? "break_cost"
            : hasColumn("breakOfChargeCost")
            ? "breakOfChargeCost"
            : "break_of_charge_cost";
          const authorizedKmKey = hasColumn("km_autorise")
            ? "km_autorise"
            : hasColumn("kmAutorise")
            ? "kmAutorise"
            : hasColumn("authorized_km")
            ? "authorized_km"
            : "km_autorise";
          const kmFeeKey = hasColumn("frais_km")
            ? "frais_km"
            : hasColumn("fraisKm")
            ? "fraisKm"
            : hasColumn("cout_km")
            ? "cout_km"
            : hasColumn("coutKm")
            ? "coutKm"
            : "frais_km";

          return {
            name: nameKey,
            breakFlag: breakFlagKey,
            breakCost: breakCostKey,
            authorizedKm: authorizedKmKey,
            kmFee: kmFeeKey,
          };
        }, [transporterSourceRows]);

        const getNextTransporterId = useCallback(() => {
          const numericIds = transporterRows
            .map((row) => Number(row.id))
            .filter((value) => Number.isFinite(value) && value > 0);

          if (!numericIds.length) {
            return 1;
          }

          return Math.max(...numericIds) + 1;
        }, [transporterRows]);

        const ensureTransporterRowsHaveIds = useCallback(() => {
          const numericIds = transporterRows
            .map((row) => Number(row.id))
            .filter((value) => Number.isFinite(value) && value > 0);

          let nextId = numericIds.length ? Math.max(...numericIds) : 0;

          return transporterRows.map((row) => {
            const numericId = Number(row.id);

            if (!Number.isFinite(numericId) || numericId <= 0) {
              nextId += 1;
              return { ...row, id: nextId };
            }

            nextId = Math.max(nextId, numericId);
            return { ...row, id: numericId };
          });
        }, [transporterRows]);

        const toggleTransporterExpansion = useCallback((transporterId) => {
          setExpandedTransporters((previous) => {
            if (previous.includes(transporterId)) {
              return previous.filter((id) => id !== transporterId);
            }
            return [...previous, transporterId];
          });
        }, []);

        const handleTariffFieldChange = (index, field, value) => {
          setTariffRows((previous) => {
            const next = [...previous];
            next[index] = { ...next[index], [field]: value };
            return next;
          });
        };

        const handleTransporterFieldChange = (index, field, value) => {
          setTransporterRows((previous) => {
            const next = [...previous];
            next[index] = { ...next[index], [field]: value };
            return next;
          });
        };

        const handleAddTransporter = () => {
          const nextId = getNextTransporterId();
          setTransporterRows((previous) => [
            ...previous,
            {
              id: nextId,
              name: "",
              hasBreakOfCharge: false,
              breakOfChargeCost: "",
              authorizedKm: "",
              kmFee: "",
            },
          ]);
        };

        const handleDeleteTransporter = async (index) => {
          const row = transporterRows[index];
          if (!row) {
            return;
          }

          const displayName =
            (row.name && row.name.trim()) ||
            (row.id ? `Transporteur #${row.id}` : "ce transporteur");

          const confirmed = window.confirm(
            `Voulez-vous supprimer ${displayName} ? Cette action supprimera √©galement ses tarifs.`,
          );

          if (!confirmed) {
            return;
          }

          try {
            setAdminError("");
            setAdminMessage("");

            if (!row.id || !transporterSourceMap.has(row.id)) {
              setTransporterRows((previous) =>
                previous.filter((_, itemIndex) => itemIndex !== index),
              );
              setAdminMessage("Transporteur supprim√©.");
              return;
            }

            setIsDeletingTransporterId(row.id);

            const transporterId = row.id;

            const { error: tariffsError } = await supabase
              .from("tarifs_transporteurs")
              .delete()
              .eq("transporteur_id", transporterId);

            if (tariffsError) throw tariffsError;

            const { error } = await supabase
              .from("transporteurs")
              .delete()
              .eq("id", transporterId);

            if (error) throw error;

            setAdminMessage("Transporteur supprim√©.");
            await loadAdminData();
            onDataUpdated?.();
          } catch (err) {
            console.error("‚ùå Erreur suppression transporteur :", err);
            setAdminError(
              err.message ||
                "Impossible de supprimer ce transporteur pour le moment.",
            );
          } finally {
            setIsDeletingTransporterId(null);
          }
        };

        const handleSaveTariffs = async () => {
          try {
            setIsSavingTariffs(true);
            setAdminError("");
            setAdminMessage("");

            const payload = [];
            const departmentById = new Map(
              rawDepartments.map((dept) => [dept.id, dept])
            );

            tariffRows.forEach((row) => {
              const tarpsCost = normalizeNumber(row.tarpsCost);
              const flatbedCost = normalizeNumber(row.flatbedCost);
              const originalTarps = normalizeNumber(row.originalTarpsCost);
              const originalFlatbed = normalizeNumber(row.originalFlatbedCost);

              const hasTarpsValue = tarpsCost !== null;
              const hasFlatbedValue = flatbedCost !== null;

              if (!row.hasExistingTariff && !hasTarpsValue && !hasFlatbedValue) {
                return;
              }

              const tarpsChanged = tarpsCost !== originalTarps;
              const flatbedChanged = flatbedCost !== originalFlatbed;

              if (!tarpsChanged && !flatbedChanged) {
                return;
              }

              let departementCodeForSave =
                (row.departmentCodeForSave && row.departmentCodeForSave.trim()) || "";

              if (!departementCodeForSave) {
                const baseDepartment = departmentById.get(row.departementId);
                if (baseDepartment?.code) {
                  departementCodeForSave = baseDepartment.code.trim();
                }
              }

              if (!departementCodeForSave && row.departmentCode) {
                const trimmed = row.departmentCode.trim();
                if (!trimmed.toLowerCase().startsWith("dept #")) {
                  departementCodeForSave = trimmed;
                }
              }

              if (!departementCodeForSave) {
                throw new Error(
                  `Impossible de d√©terminer le code du d√©partement pour ${
                    row.transporterName || `transporteur #${row.transporteurId}`
                  } (d√©partement ${row.departementId ?? "inconnu"}).`
                );
              }

              payload.push({
                transporteur_id: row.transporteurId,
                departement_code: departementCodeForSave,
                prix_bache: tarpsCost,
                prix_plateau: flatbedCost,
              });
            });

            if (!payload.length) {
              setAdminMessage("Aucune modification d√©tect√©e.");
              return;
            }

            const { error } = await supabase
              .from("tarifs_transporteurs")
              .upsert(payload, {
                onConflict: "transporteur_id,departement_code",
              });

            if (error) throw error;

            setAdminMessage("Tarifs sauvegard√©s avec succ√®s.");
            await loadAdminData();
            onDataUpdated?.();
          } catch (err) {
            console.error("‚ùå Erreur sauvegarde tarifs :", err);
            setAdminError(
              err.message || "Impossible d'enregistrer les tarifs."
            );
          } finally {
            setIsSavingTariffs(false);
          }
        };

        const handleSaveTransporters = async () => {
          try {
            setIsSavingTransporters(true);
            setAdminError("");
            setAdminMessage("");

            const rowsWithIds = ensureTransporterRowsHaveIds();
            setTransporterRows(rowsWithIds);

            const payload = rowsWithIds.map((row) => {
              if (!row.name || !row.name.trim()) {
                throw new Error(
                  "Chaque transporteur doit avoir un nom avant la sauvegarde."
                );
              }

              let breakCost = 0;
              if (row.hasBreakOfCharge) {
                const parsed = normalizeNumber(row.breakOfChargeCost || 0);
                breakCost = parsed !== null ? parsed : 0;
              }

              const authorizedKm = normalizeNumber(row.authorizedKm);
              const kmFee = normalizeNumber(row.kmFee);

              const baseRecord =
                (row.id !== undefined && row.id !== null && transporterSourceMap.get(row.id)) ||
                null;

              const payloadRow = baseRecord ? { ...baseRecord } : {};

              const numericId = Number(row.id);
              payloadRow.id = Number.isFinite(numericId) ? numericId : row.id;
              payloadRow[transporterColumnNames.name] = row.name.trim();
              payloadRow[transporterColumnNames.breakFlag] = row.hasBreakOfCharge;
              payloadRow[transporterColumnNames.breakCost] = breakCost;
              payloadRow[transporterColumnNames.authorizedKm] =
                authorizedKm !== null ? authorizedKm : null;
              payloadRow[transporterColumnNames.kmFee] =
                kmFee !== null ? kmFee : null;

              return payloadRow;
            });

            const { error } = await supabase.from("transporteurs").upsert(payload);

            if (error) throw error;

            setAdminMessage("Transporteurs sauvegard√©s avec succ√®s.");
            await loadAdminData();
            onDataUpdated?.();
          } catch (err) {
            console.error("‚ùå Erreur sauvegarde transporteurs :", err);
            setAdminError(
              err.message ||
                "Impossible d'enregistrer les transporteurs pour le moment."
            );
          } finally {
            setIsSavingTransporters(false);
          }
        };

        const handleCsvButtonClick = () => {
          fileInputRef.current?.click();
        };

        const handleCsvFileChange = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          setIsImporting(true);
          setCsvError("");
          setAdminMessage("");

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const rawText = String(reader.result || "");
              const lines = rawText
                .split(/\r?\n/)
                .map((line) => line.trim())
                .filter((line) => line.length > 0);

              if (!lines.length) {
                throw new Error("Le fichier CSV est vide.");
              }

              const delimiter = lines[0].includes(";") ? ";" : ",";
              const headers = lines[0]
                .split(delimiter)
                .map((header) => header.trim().toLowerCase());

              const getIndex = (...keys) =>
                headers.findIndex((header) => keys.includes(header));

              const transporterIdIndex = getIndex(
                "transporteur_id",
                "transporter_id",
                "transporteur"
              );
              const transporterNameIndex = getIndex(
                "transporteur_nom",
                "transporteur_name",
                "transporter_name",
                "nom"
              );
              const departmentIdIndex = getIndex(
                "departement_id",
                "department_id",
                "departement"
              );
              const departmentCodeIndex = getIndex(
                "departement_code",
                "department_code",
                "code"
              );
              const tarpsIndex = getIndex(
                "prix_bache",
                "tarif_bache",
                "prix_tarps"
              );
              const flatbedIndex = getIndex(
                "prix_plateau",
                "tarif_plateau",
                "prix_flatbed"
              );

              if (
                transporterIdIndex === -1 &&
                transporterNameIndex === -1
              ) {
                throw new Error(
                  "Le fichier CSV doit contenir une colonne 'transporteur_id' ou 'transporteur_nom'."
                );
              }

              if (departmentIdIndex === -1 && departmentCodeIndex === -1) {
                throw new Error(
                  "Le fichier CSV doit contenir une colonne 'departement_id' ou 'departement_code'."
                );
              }

              const transporterNameToId = new Map(
                rawTransporters
                  .filter((item) => item.name)
                  .map((item) => [item.name.trim().toLowerCase(), item.id])
              );
              const departmentCodeToId = new Map(
                rawDepartments
                  .filter((item) => item.code)
                  .map((item) => [item.code.trim().toLowerCase(), item.id])
              );

              const importedRows = [];
              const skipped = [];

              for (let lineIndex = 1; lineIndex < lines.length; lineIndex += 1) {
                const cells = lines[lineIndex]
                  .split(delimiter)
                  .map((cell) => cell.trim());

                if (cells.length === 1 && !cells[0]) continue;

                let transporteurId = null;
                if (transporterIdIndex !== -1) {
                  const cell = cells[transporterIdIndex];
                  const parsed = Number(cell);
                  transporteurId = Number.isFinite(parsed) ? parsed : null;
                }

                if (!transporteurId && transporterNameIndex !== -1) {
                  const nameCell = cells[transporterNameIndex]?.trim().toLowerCase();
                  transporteurId = nameCell
                    ? transporterNameToId.get(nameCell) || null
                    : null;
                }

                if (!transporteurId) {
                  skipped.push({
                    line: lineIndex + 1,
                    reason: "Transporteur introuvable",
                  });
                  continue;
                }

                let departementId = null;
                let rawDepartmentCode = "";
                if (departmentIdIndex !== -1) {
                  const cell = cells[departmentIdIndex];
                  const parsed = Number(cell);
                  departementId = Number.isFinite(parsed) ? parsed : null;
                }

                if (!departementId && departmentCodeIndex !== -1) {
                  rawDepartmentCode = cells[departmentCodeIndex] || "";
                  const codeCell = rawDepartmentCode.trim().toLowerCase();
                  departementId = codeCell
                    ? departmentCodeToId.get(codeCell) || null
                    : null;
                } else if (departmentCodeIndex !== -1) {
                  rawDepartmentCode = cells[departmentCodeIndex] || "";
                }

                if (!departementId) {
                  skipped.push({
                    line: lineIndex + 1,
                    reason: "D√©partement introuvable",
                  });
                  continue;
                }

                const tarpsValue =
                  tarpsIndex !== -1 ? formatTariffForInput(cells[tarpsIndex]) : "";
                const flatbedValue =
                  flatbedIndex !== -1
                    ? formatTariffForInput(cells[flatbedIndex])
                    : "";

                const transporter = transporterMap.get(transporteurId);
                const department = departmentMap.get(departementId);
                const departmentCodeForSave = department?.code
                  ? department.code.trim()
                  : rawDepartmentCode.trim() || null;

                importedRows.push({
                  transporteurId,
                  departementId,
                  transporterName:
                    transporter?.name || `Transporteur #${transporteurId}`,
                  departmentCode:
                    department?.code ||
                    rawDepartmentCode.trim() ||
                    `Dept #${departementId}`,
                  departmentCodeForSave: departmentCodeForSave || null,
                  departmentName: department?.name || "",
                  tarpsCost: tarpsValue,
                  flatbedCost: flatbedValue,
                });
              }

              if (!importedRows.length) {
                throw new Error(
                  "Aucune ligne valide n'a √©t√© trouv√©e dans le fichier CSV."
                );
              }

              setTariffRows((previous) => {
                const map = new Map();
                previous.forEach((row) => {
                  const key =
                    buildTariffKey(
                      row.transporteurId,
                      row.departementId,
                      row.departmentCodeForSave || row.departmentCode
                    ) || `${row.transporteurId}-${row.departementId}`;
                  map.set(key, row);
                });

                importedRows.forEach((row) => {
                  const key =
                    buildTariffKey(
                      row.transporteurId,
                      row.departementId,
                      row.departmentCodeForSave || row.departmentCode
                    ) || `${row.transporteurId}-${row.departementId}`;
                  const previousRow = map.get(key) || {};
                  map.set(key, {
                    ...previousRow,
                    ...row,
                    hasExistingTariff: previousRow.hasExistingTariff || false,
                    originalTarpsCost: previousRow.originalTarpsCost ?? "",
                    originalFlatbedCost: previousRow.originalFlatbedCost ?? "",
                  });
                });

                return Array.from(map.values()).sort((a, b) => {
                  if (a.transporterName === b.transporterName) {
                    return a.departmentCode.localeCompare(
                      b.departmentCode,
                      "fr",
                      { numeric: true }
                    );
                  }
                  return a.transporterName.localeCompare(
                    b.transporterName,
                    "fr",
                    { numeric: true }
                  );
                });
              });

              const successMessage = `${importedRows.length} ligne${
                importedRows.length > 1 ? "s" : ""
              } import√©e${importedRows.length > 1 ? "s" : ""}.`;
              setAdminMessage(successMessage);

              if (skipped.length) {
                const detail = skipped
                  .map((item) => `Ligne ${item.line} : ${item.reason}`)
                  .join(" | ");
                setCsvError(
                  `Certaines lignes ont √©t√© ignor√©es lors de l'import : ${detail}.`
                );
              }
            } catch (err) {
              console.error("‚ùå Erreur import CSV :", err);
              setCsvError(err.message || "Import CSV impossible.");
            } finally {
              setIsImporting(false);
              if (fileInputRef.current) {
                fileInputRef.current.value = "";
              }
            }
          };

          reader.onerror = () => {
            setCsvError("Impossible de lire le fichier s√©lectionn√©.");
            setIsImporting(false);
          };

          reader.readAsText(file, "utf-8");
        };

        const renderTariffTable = () => {
          if (!tariffRows.length || !groupedTariffs.length) {
            return (
              <p className="text-sm text-gray-500">
                Aucun tarif n'est actuellement disponible. Importez un CSV ou
                modifiez les valeurs existantes puis sauvegardez.
              </p>
            );
          }

          return (
            <div className="space-y-4">
              <p className="text-xs text-gray-500">
                Cliquez sur un transporteur pour afficher et modifier ses tarifs
                par d√©partement.
              </p>

              {groupedTariffs.map((group) => {
                const isExpanded = expandedTransporters.includes(
                  group.transporterId
                );

                return (
                  <div
                    key={group.transporterId}
                    className="border border-gray-200 rounded-lg overflow-hidden"
                  >
                    <button
                      type="button"
                      onClick={() => toggleTransporterExpansion(group.transporterId)}
                      className="w-full flex items-center justify-between gap-4 px-4 py-3 bg-gray-50 hover:bg-gray-100 transition"
                    >
                      <div className="text-left">
                        <p className="font-semibold text-gray-800">
                          {group.transporterName}
                        </p>
                        <p className="text-xs text-gray-500">
                          {group.departments.length} d√©partement
                          {group.departments.length > 1 ? "s" : ""}
                        </p>
                      </div>
                      <span className="text-sm text-indigo-600 font-medium">
                        {isExpanded ? "Masquer" : "Afficher"}
                      </span>
                    </button>

                    {isExpanded && (
                      <div className="overflow-x-auto border-t border-gray-200">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                          <thead className="bg-white">
                            <tr>
                              <th className="px-4 py-2 text-left font-semibold text-gray-700">
                                D√©partement
                              </th>
                              <th className="px-4 py-2 text-left font-semibold text-gray-700">
                                Prix b√¢ch√© (‚Ç¨)
                              </th>
                              <th className="px-4 py-2 text-left font-semibold text-gray-700">
                                Prix plateau (‚Ç¨)
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100">
                            {group.departments.map((row) => (
                              <tr key={`${row.transporteurId}-${row.departementId}`} className="hover:bg-gray-50">
                                <td className="px-4 py-2 text-gray-700">
                                  <div className="font-medium text-gray-800">
                                    {row.departmentCode}
                                  </div>
                                  {row.departmentName && (
                                    <div className="text-xs text-gray-500">
                                      {row.departmentName}
                                    </div>
                                  )}
                                </td>
                                <td className="px-4 py-2">
                                  <input
                                    type="text"
                                    value={row.tarpsCost ?? ""}
                                    onChange={(event) =>
                                      handleTariffFieldChange(
                                        row.rowIndex,
                                        "tarpsCost",
                                        event.target.value
                                      )
                                    }
                                    className="w-28 border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  />
                                </td>
                                <td className="px-4 py-2">
                                  <input
                                    type="text"
                                    value={row.flatbedCost ?? ""}
                                    onChange={(event) =>
                                      handleTariffFieldChange(
                                        row.rowIndex,
                                        "flatbedCost",
                                        event.target.value
                                      )
                                    }
                                    className="w-28 border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  />
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        };

        const renderTransporterTable = () => {
          if (!transporterRows.length) {
            return (
              <p className="text-sm text-gray-500">
                Aucun transporteur enregistr√©. Ajoutez-en un nouveau pour
                commencer.
              </p>
            );
          }

          return (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left font-semibold text-gray-700">
                      Nom
                    </th>
                    <th className="px-3 py-2 text-left font-semibold text-gray-700">
                      Rupture de charge
                    </th>
                    <th className="px-3 py-2 text-left font-semibold text-gray-700">
                      Co√ªt rupture (‚Ç¨)
                    </th>
                    <th className="px-3 py-2 text-left font-semibold text-gray-700">
                      KM autoris√©s
                    </th>
                    <th className="px-3 py-2 text-left font-semibold text-gray-700">
                      Frais km (‚Ç¨)
                    </th>
                    <th className="px-3 py-2 text-right font-semibold text-gray-700">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {transporterRows.map((row, index) => (
                    <tr key={row.id ? row.id : `new-${index}`} className="hover:bg-gray-50">
                      <td className="px-3 py-2">
                        <input
                          type="text"
                          value={row.name}
                          onChange={(event) =>
                            handleTransporterFieldChange(
                              index,
                              "name",
                              event.target.value
                            )
                          }
                          className="w-full border border-gray-200 rounded px-3 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="Nom du transporteur"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <label className="inline-flex items-center gap-2 text-sm text-gray-700">
                          <input
                            type="checkbox"
                            checked={Boolean(row.hasBreakOfCharge)}
                            onChange={(event) =>
                              handleTransporterFieldChange(
                                index,
                                "hasBreakOfCharge",
                                event.target.checked
                              )
                            }
                            className="h-4 w-4 text-indigo-600 border-gray-300 rounded"
                          />
                          Oui
                        </label>
                      </td>
                      <td className="px-3 py-2">
                        <input
                          type="text"
                          value={row.breakOfChargeCost ?? ""}
                          onChange={(event) =>
                            handleTransporterFieldChange(
                              index,
                              "breakOfChargeCost",
                              event.target.value
                            )
                          }
                          disabled={!row.hasBreakOfCharge}
                          className={`w-32 border border-gray-200 rounded px-3 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 ${
                            row.hasBreakOfCharge
                              ? "bg-white"
                              : "bg-gray-100 text-gray-400"
                          }`}
                          placeholder="0"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <input
                          type="text"
                          value={row.authorizedKm ?? ""}
                          onChange={(event) =>
                            handleTransporterFieldChange(
                              index,
                              "authorizedKm",
                              event.target.value
                            )
                          }
                          className="w-28 border border-gray-200 rounded px-3 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="0"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <input
                          type="text"
                          value={row.kmFee ?? ""}
                          onChange={(event) =>
                            handleTransporterFieldChange(
                              index,
                              "kmFee",
                              event.target.value
                            )
                          }
                          className="w-28 border border-gray-200 rounded px-3 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="0"
                        />
                      </td>
                      <td className="px-3 py-2 text-right">
                        <button
                          type="button"
                          onClick={() => handleDeleteTransporter(index)}
                          disabled={
                            isSavingTransporters ||
                            isSavingTariffs ||
                            isImporting ||
                            (row.id !== undefined &&
                              row.id !== null &&
                              isDeletingTransporterId === row.id)
                          }
                          className="inline-flex items-center gap-1 rounded-md border border-red-200 px-3 py-1 text-xs font-medium text-red-600 hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
                        >
                          <TrashIcon size={14} /> Supprimer
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
            <div className="max-w-7xl mx-auto space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div className="flex items-center gap-3">
                  <SettingsIcon className="text-indigo-600" size={32} />
                  <div>
                    <h1 className="text-3xl font-bold text-gray-800">
                      Administration des tarifs
                    </h1>
                    <p className="text-sm text-gray-500">
                      {session?.user?.email || "Administrateur"}
                    </p>
                  </div>
                </div>
                <div className="flex flex-wrap justify-end gap-3">
                  <button
                    onClick={() => loadAdminData()}
                    className="inline-flex items-center gap-2 rounded-lg border border-indigo-200 bg-white px-4 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-50 disabled:opacity-50"
                    disabled={adminLoading}
                  >
                    <RefreshIcon size={16} /> Actualiser
                  </button>
                  <button
                    onClick={onExit}
                    className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700"
                  >
                    <RouteIcon size={16} /> Aller √† l'outil
                  </button>
                </div>
              </div>

              {adminError && (
                <div className="bg-red-50 text-red-600 text-sm px-4 py-3 rounded-lg">
                  {adminError}
                </div>
              )}

              {adminMessage && (
                <div className="bg-emerald-50 text-emerald-700 text-sm px-4 py-3 rounded-lg">
                  {adminMessage}
                </div>
              )}

              {csvError && (
                <div className="bg-amber-50 text-amber-700 text-sm px-4 py-3 rounded-lg">
                  {csvError}
                </div>
              )}

              <div className="bg-white rounded-xl shadow-lg">
                <div className="border-b border-gray-200 flex">
                  <button
                    onClick={() => setActiveTab("tarifs")}
                    className={`flex-1 px-4 py-3 text-sm font-medium ${
                      activeTab === "tarifs"
                        ? "text-indigo-600 border-b-2 border-indigo-600"
                        : "text-gray-500 hover:text-indigo-600"
                    }`}
                  >
                    Tarifs
                  </button>
                  <button
                    onClick={() => setActiveTab("transporteurs")}
                    className={`flex-1 px-4 py-3 text-sm font-medium ${
                      activeTab === "transporteurs"
                        ? "text-indigo-600 border-b-2 border-indigo-600"
                        : "text-gray-500 hover:text-indigo-600"
                    }`}
                  >
                    Transporteurs
                  </button>
                </div>

                <div className="p-6 space-y-4">
                  {adminLoading ? (
                    <div className="flex justify-center py-12 text-gray-500">
                      Chargement des donn√©es d'administration...
                    </div>
                  ) : activeTab === "tarifs" ? (
                    <>
                      <div className="flex flex-wrap items-center justify-between gap-3">
                        <span className="text-sm text-gray-500">
                          {groupedTariffs.length} transporteur
                          {groupedTariffs.length > 1 ? "s" : ""} ‚Ä¢ {rawDepartments.length}
                          {" "}d√©partement{rawDepartments.length > 1 ? "s" : ""}
                        </span>
                        <div className="flex flex-wrap gap-3">
                          <button
                            onClick={handleCsvButtonClick}
                            className="inline-flex items-center gap-2 rounded-lg border border-indigo-200 bg-white px-4 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-50 disabled:opacity-50"
                            disabled={isImporting}
                          >
                            <UploadIcon size={16} /> Import CSV
                          </button>
                          <button
                            onClick={handleSaveTariffs}
                            className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-50"
                            disabled={isSavingTariffs}
                          >
                            <SaveIcon size={16} /> Sauvegarder
                          </button>
                        </div>
                      </div>
                      <p className="text-xs text-gray-500">
                        Colonnes attendues pour l'import CSV : transporteur_id ou
                        transporteur_nom/transporteur_name, departement_id ou
                        departement_code, prix_bache, prix_plateau.
                      </p>
                      {renderTariffTable()}
                    </>
                  ) : (
                    <>
                      <div className="flex flex-wrap items-center justify-between gap-3">
                        <span className="text-sm text-gray-500">
                          {transporterRows.length} transporteur{transporterRows.length > 1 ? "s" : ""}
                        </span>
                        <div className="flex flex-wrap gap-3">
                          <button
                            onClick={handleAddTransporter}
                            className="inline-flex items-center gap-2 rounded-lg border border-indigo-200 bg-white px-4 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-50"
                          >
                            <UsersIcon size={16} /> Ajouter un transporteur
                          </button>
                          <button
                            onClick={handleSaveTransporters}
                            className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-50"
                            disabled={isSavingTransporters}
                          >
                            <SaveIcon size={16} /> Sauvegarder
                          </button>
                        </div>
                      </div>
                      {renderTransporterTable()}
                    </>
                  )}
                </div>
              </div>
            </div>

            <input
              type="file"
              ref={fileInputRef}
              accept=".csv"
              className="hidden"
              onChange={handleCsvFileChange}
            />
          </div>
        );
      }

      /********************************************
       *  COMPOSANT PRINCIPAL
       ********************************************/
      function TransportOptimizer() {
        const [departments, setDepartments] = useState([]);
        const [transporters, setTransporters] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState("");
        const [selectedDepts, setSelectedDepts] = useState([]);
        const [truckType, setTruckType] = useState("non-specifie"); // "bache", "plateau" ou "non-specifie"
        const [bordereau, setBordereau] = useState("");
        const [hasSearched, setHasSearched] = useState(false);
        const [session, setSession] = useState(null);
        const [authLoading, setAuthLoading] = useState(true);
        const [authError, setAuthError] = useState("");
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [logs, setLogs] = useState([]);
        const [logsLoading, setLogsLoading] = useState(false);
        const [logsError, setLogsError] = useState("");
        const [showAllLogs, setShowAllLogs] = useState(false);
        const [logSearch, setLogSearch] = useState("");
        const [isSearching, setIsSearching] = useState(false);
        const [isSavingLog, setIsSavingLog] = useState(false);
        const [showTransporters, setShowTransporters] = useState(false);
        const [selectedResultIndex, setSelectedResultIndex] = useState(null);
        const [reasons, setReasons] = useState({});
        const [validationError, setValidationError] = useState("");
        const [validationMessage, setValidationMessage] = useState("");
        const [routeMetrics, setRouteMetrics] = useState({
          totalDistanceKm: 0,
          detourKm: 0,
          loading: false,
          error: "",
        });
        const resultsRef = useRef(null);
        const [departmentSearch, setDepartmentSearch] = useState("");
        const [dataReloadFlag, setDataReloadFlag] = useState(0);
        const [adminPanelActive, setAdminPanelActive] = useState(false);
        const [adminAutoOpened, setAdminAutoOpened] = useState(false);
        const [isRegistering, setIsRegistering] = useState(false);
        const [registerUsername, setRegisterUsername] = useState("");
        const [registerPassword, setRegisterPassword] = useState("");
        const [registerError, setRegisterError] = useState("");
        const [registerMessage, setRegisterMessage] = useState("");
        const [isCreatingAccount, setIsCreatingAccount] = useState(false);
        const [isLoginPasswordVisible, setIsLoginPasswordVisible] = useState(false);
        const [isRegisterPasswordVisible, setIsRegisterPasswordVisible] = useState(false);
        const [isRouteReversed, setIsRouteReversed] = useState(false);

        const handleDataRefresh = useCallback(() => {
          setDataReloadFlag((value) => value + 1);
        }, []);

        const currentYear = new Date().getFullYear();
        const BORDEREAU_REGEX = new RegExp(`^23/${currentYear}/(?!0000)\\d{4}$`);

        const userIdentifier = session?.user?.id || session?.user?.email || null;
        const userDisplayName =
          session?.user?.user_metadata?.username ||
          session?.user?.user_metadata?.full_name ||
          session?.user?.email ||
          "Utilisateur";
        const userEmail = session?.user?.email?.toLowerCase() || "";
        const isAdmin = ADMIN_EMAILS.includes(userEmail);

        const fetchLogs = useCallback(async () => {
          if (!userIdentifier) {
            setLogs([]);
            setLogsError("");
            return;
          }

          try {
            setLogsLoading(true);
            setLogsError("");
            const { data, error } = await supabase
              .from("logs")
              .select("*")
              .eq("identifiant", userIdentifier)
              .order("date_recherche", { ascending: false });

            if (error) throw error;

            setLogs(data || []);
          } catch (err) {
            console.error("‚ùå Erreur r√©cup√©ration logs :", err);
            setLogsError(err.message || "Impossible de r√©cup√©rer l'historique.");
          } finally {
            setLogsLoading(false);
          }
        }, [userIdentifier]);

        useEffect(() => {
          if (!userIdentifier) {
            setLogs([]);
            setLogsError("");
            setLogsLoading(false);
            setShowAllLogs(false);
            return;
          }

          fetchLogs();
        }, [userIdentifier, fetchLogs]);

        useEffect(() => {
          if (!session) {
            setAdminPanelActive(false);
            setAdminAutoOpened(false);
          }
        }, [session]);

        useEffect(() => {
          if (!isAdmin) {
            setAdminPanelActive(false);
            setAdminAutoOpened(false);
            return;
          }

          if (!adminAutoOpened) {
            setAdminPanelActive(true);
            setAdminAutoOpened(true);
          }
        }, [isAdmin, adminAutoOpened]);

        /********************************************
         *  CHARGEMENT DES DONN√âES SUPABASE
         ********************************************/
        useEffect(() => {
          let isMounted = true;

          async function initAuth() {
            try {
              setAuthError("");
              const {
                data: { session },
                error,
              } = await supabase.auth.getSession();
              if (error) throw error;
              if (isMounted) setSession(session);
            } catch (err) {
              console.error("‚ùå Erreur d'authentification :", err);
              if (isMounted)
                setAuthError(err.message || "Impossible de v√©rifier la session Supabase.");
            } finally {
              if (isMounted) setAuthLoading(false);
            }
          }

          const {
            data: { subscription },
          } = supabase.auth.onAuthStateChange((_event, session) => {
            if (isMounted) {
              setSession(session);
            }
          });

          initAuth();

          return () => {
            isMounted = false;
            subscription.unsubscribe();
          };
        }, []);

        useEffect(() => {
          if (!session) {
            setDepartments([]);
            setTransporters([]);
            setLoading(false);
            return;
          }

          let isActive = true;

          async function loadData() {
            try {
              setLoading(true);
              setError("");

              const [departmentsResult, transportersResult, tariffsResult] =
                await Promise.all([
                  supabase.from("departements").select("*"),
                  supabase.from("transporteurs").select("*"),
                  supabase.from("tarifs_transporteurs").select("*"),
                ]);

              if (departmentsResult.error) throw departmentsResult.error;
              if (transportersResult.error) throw transportersResult.error;
              if (tariffsResult.error) throw tariffsResult.error;

              const deptMap = new Map();
              (departmentsResult.data || []).forEach((dept) => {
                const code =
                  dept.code ||
                  dept.departement_code ||
                  dept.department_code ||
                  dept.code_insee ||
                  "";

                if (!code) {
                  return;
                }

                const latitudeRaw =
                  dept.latitude ??
                  dept.lat ??
                  dept.lat_geographique ??
                  dept.lat_geo ??
                  null;
                const longitudeRaw =
                  dept.longitude ??
                  dept.long ??
                  dept.lng ??
                  dept.lon ??
                  dept.long_geographique ??
                  dept.long_geo ??
                  null;

                const latitude = Number(latitudeRaw);
                const longitude = Number(longitudeRaw);

                if (!deptMap.has(code)) {
                  deptMap.set(code, {
                    id: dept.id ?? code,
                    code,
                    name: dept.name || dept.nom || dept.libelle || "",
                    km: dept.km ?? dept.distance ?? null,
                    latitude: Number.isFinite(latitude) ? latitude : null,
                    longitude: Number.isFinite(longitude) ? longitude : null,
                  });
                }
              });

              if (!deptMap.size) {
                if (!isActive) return;
                setError(
                  "Aucun d√©partement disponible. Merci de v√©rifier les donn√©es Supabase.",
                );
                setDepartments([]);
                setTransporters([]);
                return;
              }

              const deptList = Array.from(deptMap.values()).sort((a, b) =>
                a.code.localeCompare(b.code, "fr", { numeric: true })
              );

              const transportersMap = new Map();
              (transportersResult.data || []).forEach((transporter) => {
                const breakOfChargeRaw =
                  transporter.break_of_charge ??
                  transporter.has_break_of_charge ??
                  transporter.hasBreakOfCharge ??
                  false;
                const breakOfChargeCostRaw =
                  transporter.break_of_charge_cost ??
                  transporter.breakOfChargeCost ??
                  transporter.break_cost ??
                  null;
                const authorizedKmRaw =
                  transporter.km_autorise ??
                  transporter.kmAutorise ??
                  transporter.km_autorized ??
                  transporter.authorized_km ??
                  null;
                const kmFeeRaw =
                  transporter.frais_km ??
                  transporter.fraisKm ??
                  transporter.cout_km ??
                  transporter.coutKm ??
                  null;

                transportersMap.set(transporter.id, {
                  id: transporter.id,
                  name:
                    transporter.nom ||
                    transporter.name ||
                    transporter.libelle ||
                    "",
                  hasBreakOfCharge: Boolean(breakOfChargeRaw),
                  breakOfChargeCost:
                    breakOfChargeCostRaw !== undefined &&
                    breakOfChargeCostRaw !== null
                      ? Number(breakOfChargeCostRaw)
                      : 0,
                  authorizedKm:
                    authorizedKmRaw !== undefined && authorizedKmRaw !== null
                      ? Number(authorizedKmRaw)
                      : null,
                  kmFee:
                    kmFeeRaw !== undefined && kmFeeRaw !== null
                      ? Number(kmFeeRaw)
                      : 0,
                  rates: [],
                });
              });

              (tariffsResult.data || []).forEach((tariff) => {
                const transporter = transportersMap.get(tariff.transporteur_id);
                if (!transporter) {
                  return;
                }

                const deptCode =
                  tariff.departement_code || tariff.department_code || "";
                const dept = deptMap.get(deptCode);

                if (!dept) {
                  return;
                }

                transporter.rates.push({
                  deptId: dept.id,
                  departmentCode: dept.code,
                  kmFromSprimont: dept.km,
                  tarpsCost: tariff.prix_bache,
                  flatbedCost: tariff.prix_plateau,
                });
              });

              if (!isActive) return;

              setDepartments(deptList);
              setTransporters(Array.from(transportersMap.values()));
            } catch (err) {
              console.error("‚ùå Erreur Supabase :", err);
              if (isActive) setError(err.message || "Erreur inconnue");
            } finally {
              if (isActive) setLoading(false);
            }
          }

          loadData();

          return () => {
            isActive = false;
          };
        }, [session, dataReloadFlag]);

        /********************************************
         *  CALCUL DU MEILLEUR TRANSPORTEUR
         ********************************************/
        const baseRoute = useMemo(
          () => calculateOptimalRoute(selectedDepts, departments),
          [selectedDepts, departments]
        );

        const optimalRoute = useMemo(() => {
          if (isRouteReversed && baseRoute.length === 2) {
            return [...baseRoute].reverse();
          }
          return baseRoute;
        }, [baseRoute, isRouteReversed]);

        useEffect(() => {
          if (selectedDepts.length !== 2) {
            setIsRouteReversed(false);
          }
        }, [selectedDepts]);

        const selectedDepartmentList = useMemo(() => {
          return selectedDepts
            .map((id) => departments.find((dept) => dept.id === id))
            .filter(Boolean);
        }, [selectedDepts, departments]);

        const filteredDepartments = useMemo(() => {
          const query = departmentSearch.trim().toLowerCase();

          if (!query) {
            return departments;
          }

          return departments.filter((dept) => {
            const codeMatch = dept.code?.toLowerCase().includes(query);
            const nameMatch = dept.name?.toLowerCase().includes(query);
            return codeMatch || nameMatch;
          });
        }, [departmentSearch, departments]);

        const routeDistanceCacheRef = useRef(new Map());

        useEffect(() => {
          let isActive = true;

          const computeRouteMetrics = async () => {
            if (!optimalRoute.length) {
              if (!isActive) return;
              setRouteMetrics({
                totalDistanceKm: 0,
                detourKm: 0,
                loading: false,
                error: "",
              });
              return;
            }

            const baseCoords = { lat: 50.5333, lon: 5.6203 };
            const deptCoords = optimalRoute.map((dept) => {
              if (
                Number.isFinite(dept?.latitude) &&
                Number.isFinite(dept?.longitude)
              ) {
                return { lat: Number(dept.latitude), lon: Number(dept.longitude) };
              }
              return null;
            });

            if (deptCoords.some((item) => item === null)) {
              if (!isActive) return;
              setRouteMetrics({
                totalDistanceKm: 0,
                detourKm: 0,
                loading: false,
                error:
                  "Coordonn√©es manquantes pour au moins un d√©partement s√©lectionn√©.",
              });
              return;
            }

            const coordsList = [baseCoords, ...deptCoords];

            setRouteMetrics((prev) => ({ ...prev, loading: true, error: "" }));
            const cache = routeDistanceCacheRef.current;

            try {
              const cacheKey = coordsList
                .map((coord) => `${coord.lon},${coord.lat}`)
                .join("|");

              let distancesMatrix = cache.get(cacheKey) || null;

              if (!distancesMatrix) {
                const response = await fetch(
                  "https://api.openrouteservice.org/v2/matrix/driving-hgv",
                  {
                    method: "POST",
                    headers: {
                      Authorization: OPENROUTESERVICE_API_KEY,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      locations: coordsList.map((coord) => [coord.lon, coord.lat]),
                      metrics: ["distance"],
                      units: "km",
                    }),
                  }
                );

                if (!response.ok) {
                  throw new Error("Impossible de calculer la matrice de distances.");
                }

                const data = await response.json();
                if (!Array.isArray(data?.distances)) {
                  throw new Error(
                    "Distance manquante dans la r√©ponse OpenRouteService (matrix)."
                  );
                }

                distancesMatrix = data.distances;
                cache.set(cacheKey, distancesMatrix);
              }

              let segmentDistanceSum = 0;
              for (let i = 0; i < coordsList.length - 1; i += 1) {
                const segmentKm = distancesMatrix?.[i]?.[i + 1];
                if (!Number.isFinite(segmentKm)) {
                  throw new Error(
                    "Distance manquante dans la matrice pour un trajet interm√©diaire."
                  );
                }
                segmentDistanceSum += segmentKm;
              }

              const directDistanceKm = distancesMatrix?.[0]?.[coordsList.length - 1];
              if (!Number.isFinite(directDistanceKm)) {
                throw new Error(
                  "Distance directe manquante dans la matrice OpenRouteService."
                );
              }

              const totalDistanceKm = segmentDistanceSum;
              let detourKm = Math.max(0, totalDistanceKm - directDistanceKm);

              if (isRouteReversed && optimalRoute.length === 2) {
                const [firstDept, secondDept] = optimalRoute;
                const kmValues = [
                  Number(firstDept?.km),
                  Number(secondDept?.km),
                ].filter((value) => Number.isFinite(value));

                if (kmValues.length === 2) {
                  const closestKm = Math.min(...kmValues);
                  const furthestKm = Math.max(...kmValues);
                  detourKm = Math.max(0, furthestKm - closestKm);
                }
              }

              if (!isActive) return;
              setRouteMetrics({
                totalDistanceKm,
                detourKm,
                loading: false,
                error: "",
              });
            } catch (err) {
              console.error("‚ùå Erreur OpenRouteService :", err);
              if (!isActive) return;
              setRouteMetrics({
                totalDistanceKm: 0,
                detourKm: 0,
                loading: false,
                error:
                  err?.message ||
                  "Impossible de calculer le d√©tour avec OpenRouteService.",
              });
            }
          };

          computeRouteMetrics();

          return () => {
            isActive = false;
          };
        }, [optimalRoute]);

        const bestTransporters = useMemo(() => {
          if (!selectedDepts.length || !truckType || !transporters.length) return [];
          if (routeMetrics.loading || routeMetrics.error) return [];

          const rankedResults = [];

          const selectRateCost = (rate, selectedTruckType) => {
            const parsedTarps = parseTariff(rate.tarpsCost);
            const parsedFlatbed = parseTariff(rate.flatbedCost);

            if (selectedTruckType === "bache") {
              return {
                available: parsedTarps.available,
                value: parsedTarps.value,
                label: "bach√©",
              };
            }

            if (selectedTruckType === "plateau") {
              return {
                available: parsedFlatbed.available,
                value: parsedFlatbed.value,
                label: "plateau",
              };
            }

            const candidates = [];
            if (parsedTarps.available) {
              candidates.push({ value: parsedTarps.value, label: "bach√©" });
            }
            if (parsedFlatbed.available) {
              candidates.push({ value: parsedFlatbed.value, label: "plateau" });
            }

            if (!candidates.length) {
              return { available: false };
            }

            const bestCandidate = candidates.sort((a, b) => a.value - b.value)[0];
            return { available: true, value: bestCandidate.value, label: bestCandidate.label };
          };

          for (const transporter of transporters) {
            const deptRates = [];
            let hasMissingTariff = false;

            for (const dept of optimalRoute) {
              const rate = transporter.rates.find((r) => r.deptId === dept.id);

              if (!rate) {
                hasMissingTariff = true;
                break;
              }

              deptRates.push({ dept, rate });
            }

            if (hasMissingTariff) {
              continue;
            }

            const resolveTruckType = () => {
              if (truckType !== "non-specifie") {
                return truckType;
              }

              const candidates = [];

              const computeFurthestCost = (type) => {
                let furthest = null;

                for (const { rate } of deptRates) {
                  const parsedRate =
                    type === "bache"
                      ? parseTariff(rate.tarpsCost)
                      : parseTariff(rate.flatbedCost);

                  if (!parsedRate.available) {
                    return null;
                  }

                  if (furthest === null || parsedRate.value > furthest) {
                    furthest = parsedRate.value;
                  }
                }

                return furthest;
              };

              const furthestTarpsCost = computeFurthestCost("bache");
              if (furthestTarpsCost !== null) {
                candidates.push({ type: "bache", furthestCost: furthestTarpsCost });
              }

              const furthestFlatbedCost = computeFurthestCost("plateau");
              if (furthestFlatbedCost !== null) {
                candidates.push({ type: "plateau", furthestCost: furthestFlatbedCost });
              }

              if (!candidates.length) {
                return null;
              }

              return candidates.sort((a, b) => a.furthestCost - b.furthestCost)[0].type;
            };

            const resolvedTruckType = resolveTruckType();

            if (!resolvedTruckType) {
              continue;
            }

            let furthestCost = null;
            let furthestDeptDetail = "";
            const details = [];

            for (let idx = 0; idx < deptRates.length; idx += 1) {
              const { dept, rate } = deptRates[idx];
              const selectedRate = selectRateCost(rate, resolvedTruckType);

              if (!selectedRate.available) {
                hasMissingTariff = true;
                break;
              }

              details.push(
                `${idx + 1}. ${dept.name} (${dept.km} km): ${selectedRate.value.toFixed(2)}‚Ç¨ (${selectedRate.label})`
              );

              if (furthestCost === null || selectedRate.value >= furthestCost) {
                furthestCost = selectedRate.value;
                furthestDeptDetail = `${dept.name} (${dept.km} km)`;
              }
            }

            if (hasMissingTariff || furthestCost === null) {
              continue;
            }

            if (furthestDeptDetail) {
              details.push(
                `‚Üí Co√ªt retenu (d√©partement le plus √©loign√© : ${furthestDeptDetail}) : ${furthestCost.toFixed(2)}‚Ç¨`
              );
            }

            if (routeMetrics.totalDistanceKm > 0) {
              details.push(
                `Trajet estim√© : ${routeMetrics.totalDistanceKm.toFixed(2)} km (d√©tour : ${routeMetrics.detourKm.toFixed(2)} km)`
              );
            }

            let totalCost = furthestCost;

            if (transporter.hasBreakOfCharge) {
              const breakCost = Number(transporter.breakOfChargeCost);
              const breaksCount = Math.max(0, optimalRoute.length - 1);

              if (!Number.isFinite(breakCost) || breakCost < 0) {
                continue;
              }

              if (breaksCount > 0 && breakCost > 0) {
                const totalBreakCost = breakCost * breaksCount;
                totalCost += totalBreakCost;
                details.push(
                  `+ Rupture de charge (${breaksCount} √ó ${breakCost.toFixed(2)}‚Ç¨) : ${totalBreakCost.toFixed(2)}‚Ç¨`
                );
              }
            }

            const kmFee = Number(transporter.kmFee);
            const authorizedDetourKmRaw = Number(transporter.authorizedKm);
            const authorizedDetourKm =
              Number.isFinite(authorizedDetourKmRaw) && authorizedDetourKmRaw > 0
                ? authorizedDetourKmRaw
                : 0;

            if (routeMetrics.detourKm > 0) {
              if (!Number.isFinite(kmFee) || kmFee < 0) {
                continue;
              }

              const billableDetourKm = Math.max(
                0,
                routeMetrics.detourKm - authorizedDetourKm
              );

              if (billableDetourKm > 0) {
                const detourCost = billableDetourKm * kmFee;
                totalCost += detourCost;
                details.push(
                  `+ D√©tour (${billableDetourKm.toFixed(2)} km factur√©s apr√®s ${authorizedDetourKm.toFixed(2)} km offerts √ó ${kmFee.toFixed(2)}‚Ç¨) : ${detourCost.toFixed(2)}‚Ç¨`
                );
              } else if (authorizedDetourKm > 0) {
                details.push(
                  `+ D√©tour : ${routeMetrics.detourKm.toFixed(2)} km (0‚Ç¨ car ${authorizedDetourKm.toFixed(2)} km offerts)`
                );
              }
            }

            rankedResults.push({ transporter, totalCost, details });
          }

          return rankedResults.sort((a, b) => a.totalCost - b.totalCost);
        }, [optimalRoute, routeMetrics, transporters, truckType]);

        useEffect(() => {
          const topLength = Math.min(3, bestTransporters.length);

          if (
            selectedResultIndex !== null &&
            selectedResultIndex >= topLength
          ) {
            setSelectedResultIndex(null);
          }

          setReasons((prev) => {
            let changed = false;
            const next = {};

            Object.keys(prev).forEach((key) => {
              const idx = Number(key);
              if (!Number.isNaN(idx) && idx < topLength && prev[key]) {
                next[key] = prev[key];
              } else if (!changed) {
                changed = true;
              }
            });

            if (!changed) {
              const prevKeys = Object.keys(prev);
              const nextKeys = Object.keys(next);
              if (prevKeys.length !== nextKeys.length) {
                changed = true;
              }
            }

            return changed ? next : prev;
          });
        }, [bestTransporters, selectedResultIndex]);

        const formatTruckRate = (rawCost) => {
          const parsed = parseTariff(rawCost);
          if (!parsed.available) {
            return "Tarif indisponible";
          }
          return `${parsed.value.toFixed(2)}‚Ç¨`;
        };

        const formatLogDate = (value) => {
          if (!value) return "";
          try {
            return new Date(value).toLocaleString("fr-FR", {
              dateStyle: "short",
              timeStyle: "short",
            });
          } catch (err) {
            return value;
          }
        };

        const formatChoiceDisplay = (choiceName, rawCost) => {
          const trimmedName = typeof choiceName === "string" ? choiceName.trim() : "";
          const numericCost = Number(rawCost);
          const hasNumericCost = Number.isFinite(numericCost);

          if (trimmedName && hasNumericCost) {
            return `${trimmedName} (${numericCost.toFixed(2)}‚Ç¨)`;
          }

          if (trimmedName) {
            return trimmedName;
          }

          if (hasNumericCost) {
            return `${numericCost.toFixed(2)}‚Ç¨`;
          }

          return null;
        };

        const formatDifferenceValue = (difference) => {
          if (difference === null || difference === undefined) {
            return null;
          }

          const numericDifference = Number(difference);
          if (!Number.isFinite(numericDifference)) {
            return null;
          }

          return numericDifference;
        };

        const filteredLogs = useMemo(() => {
          const normalizedSearch = logSearch.trim().toLowerCase();
          if (!normalizedSearch) {
            return logs;
          }

          return logs.filter((log) => {
            const bordereauValue = (log.bordereau || "").toLowerCase();
            return bordereauValue.includes(normalizedSearch);
          });
        }, [logSearch, logs]);

        const visibleLogs = useMemo(() => {
          if (showAllLogs) {
            return filteredLogs;
          }
          return filteredLogs.slice(0, 5);
        }, [filteredLogs, showAllLogs]);

        const scrollToResults = () => {
          if (resultsRef.current) {
            resultsRef.current.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        };

        const handleSearch = () => {
          setHasSearched(true);
          setSelectedResultIndex(null);
          setReasons({});
          setValidationError("");
          setValidationMessage("");
          setIsSearching(true);

          setTimeout(() => {
            scrollToResults();
            setIsSearching(false);
          }, 150);
        };

        const handleDepartmentSearchKeyDown = useCallback(
          (event) => {
            if (event.key !== "Enter") {
              return;
            }

            if (filteredDepartments.length !== 1) {
              return;
            }

            const soleDepartment = filteredDepartments[0];
            if (!soleDepartment) {
              return;
            }

            const inputElement = event.currentTarget;
            const alreadySelected = selectedDepts.includes(soleDepartment.id);

            event.preventDefault();
            if (!alreadySelected) {
              setSelectedDepts((prev) => {
                if (prev.includes(soleDepartment.id)) {
                  return prev;
                }

                return [...prev, soleDepartment.id];
              });
            }

            if (inputElement && typeof inputElement.select === "function") {
              requestAnimationFrame(() => {
                inputElement.select();
              });
            }
          },
          [filteredDepartments, selectedDepts]
        );

        const toggleDepartmentSelection = useCallback((deptId) => {
          setSelectedDepts((prev) => {
            if (prev.includes(deptId)) {
              return prev.filter((id) => id !== deptId);
            }

            return [...prev, deptId];
          });
        }, []);

        const handleValidate = async () => {
          if (!bestTransporters.length) {
            setValidationError("Aucun r√©sultat √† valider.");
            return;
          }

          if (selectedResultIndex === null) {
            setValidationError("Veuillez s√©lectionner un transporteur.");
            return;
          }

          if (!userIdentifier) {
            setValidationError(
              "Vous devez √™tre connect√© pour enregistrer le r√©sultat."
            );
            return;
          }

          try {
            setValidationError("");
            setValidationMessage("");
            setIsSavingLog(true);

            const formattedDepartments = optimalRoute
              .map((dept) => `${dept.code} - ${dept.name}`)
              .join(", ");

            const rankedChoices = bestTransporters.slice(0, 3);
            const selectedChoice = rankedChoices[selectedResultIndex];
            const bestChoice = bestTransporters[0] || null;
            const differenceValue =
              bestChoice && selectedChoice
                ? Math.max(
                    0,
                    selectedChoice.totalCost - bestChoice.totalCost
                  )
                : null;

            if (!selectedChoice) {
              setValidationError("Le transporteur s√©lectionn√© est invalide.");
              setIsSavingLog(false);
              return;
            }

            const payload = {
              identifiant: userIdentifier,
              utilisateur: userDisplayName,
              bordereau,
              departements: formattedDepartments || null,
              attributs:
                truckType === "bache"
                  ? "Camion bach√©"
                  : truckType === "plateau"
                  ? "Camion plateau"
                  : "Type non sp√©cifi√©",
              resultat: selectedChoice.transporter.name,
              choix_1: rankedChoices[0]
                ? rankedChoices[0].transporter.name
                : null,
              choix_2: rankedChoices[1]
                ? rankedChoices[1].transporter.name
                : null,
              choix_3: rankedChoices[2]
                ? rankedChoices[2].transporter.name
                : null,
              cout_1: rankedChoices[0]
                ? Number(rankedChoices[0].totalCost.toFixed(2))
                : null,
              cout_2: rankedChoices[1]
                ? Number(rankedChoices[1].totalCost.toFixed(2))
                : null,
              cout_3: rankedChoices[2]
                ? Number(rankedChoices[2].totalCost.toFixed(2))
                : null,
              difference:
                differenceValue !== null
                  ? Number(differenceValue.toFixed(2))
                  : null,
              raison_1: reasons[0] ? reasons[0].trim() || null : null,
              raison_2: reasons[1] ? reasons[1].trim() || null : null,
              raison_3: reasons[2] ? reasons[2].trim() || null : null,
            };

            const { error } = await supabase.from("logs").insert([payload]);

            if (error) {
              throw error;
            }

            setValidationMessage("R√©sultat enregistr√© avec succ√®s.");
            await fetchLogs();
          } catch (err) {
            console.error("‚ùå Erreur lors de l'enregistrement du log :", err);
            setValidationError(
              err.message || "Impossible d'enregistrer le r√©sultat."
            );
          } finally {
            setIsSavingLog(false);
          }
        };

        const handleLogin = useCallback(
          async (event) => {
            event?.preventDefault();

            const trimmedIdentifier = email.trim();
            if (!trimmedIdentifier || !password) return;

            try {
              setAuthError("");

              let authEmail;
              if (trimmedIdentifier.includes("@")) {
                if (trimmedIdentifier.endsWith("@users.eloy")) {
                  authEmail = trimmedIdentifier;
                } else {
                  setAuthError(
                    "Pour vous connecter, utilisez votre nom d'utilisateur choisi lors de l'inscription."
                  );
                  return;
                }
              } else {
                authEmail = buildAuthEmailFromUsername(trimmedIdentifier);
                if (!authEmail) {
                  setAuthError("Nom d'utilisateur invalide.");
                  return;
                }
              }

              const { error } = await supabase.auth.signInWithPassword({
                email: authEmail,
                password,
              });
              if (error) throw error;
            } catch (err) {
              console.error("‚ùå Erreur de connexion :", err);
              setAuthError(err.message || "Impossible de se connecter.");
            }
          },
          [email, password]
        );

        const handleSignUp = useCallback(
          async (event) => {
            event?.preventDefault();
            setRegisterError("");
            setRegisterMessage("");

            const trimmedUsername = registerUsername.trim();

            if (!trimmedUsername) {
              setRegisterError(
                "Merci d'indiquer un nom d'utilisateur pour la connexion."
              );
              return;
            }

            const normalizedUsername = sanitizeUsername(trimmedUsername);
            if (!normalizedUsername) {
              setRegisterError(
                "Le nom d'utilisateur ne doit contenir que des lettres, chiffres ou caract√®res ._-"
              );
              return;
            }

            if (!registerPassword) {
              setRegisterError("Merci d'indiquer un mot de passe.");
              return;
            }

            const authEmail = buildAuthEmailFromUsername(trimmedUsername);
            if (!authEmail) {
              setRegisterError(
                "Impossible de g√©n√©rer un identifiant de connexion pour ce nom d'utilisateur."
              );
              return;
            }

            try {
              setIsCreatingAccount(true);
              const passwordValue = registerPassword;
              const { error } = await supabase.auth.signUp({
                email: authEmail,
                password: registerPassword,
                options: {
                  data: {
                    username: trimmedUsername,
                    normalized_username: normalizedUsername,
                    auth_email: authEmail,
                  },
                },
              });

              if (error) throw error;

              const identifierMessage =
                trimmedUsername === normalizedUsername
                  ? `"${trimmedUsername}"`
                  : `"${trimmedUsername}" (identifiant utilis√© : "${normalizedUsername}")`;

              setRegisterMessage(
                `Compte cr√©√© avec succ√®s ! Vous pourrez d√©sormais vous connecter avec le nom d'utilisateur ${identifierMessage}.`
              );
              setEmail(trimmedUsername);
              setPassword(passwordValue);
              setRegisterUsername("");
              setRegisterPassword("");
              setIsRegisterPasswordVisible(false);
              setIsLoginPasswordVisible(false);
            } catch (err) {
              console.error("‚ùå Erreur lors de la cr√©ation du compte :", err);
              const message = String(err?.message || "");
              if (
                message.toLowerCase().includes("duplicate") ||
                message.toLowerCase().includes("already")
              ) {
                setRegisterError(
                  "Ce nom d'utilisateur est d√©j√† utilis√©. Merci d'en choisir un autre."
                );
              } else {
                setRegisterError(
                  message || "Impossible de cr√©er le compte utilisateur."
                );
              }
            } finally {
              setIsCreatingAccount(false);
            }
          },
          [registerPassword, registerUsername]
        );

        /********************************************
         *  INTERFACE UTILISATEUR
         ********************************************/
        if (authLoading)
          return (
            <div className="flex items-center justify-center h-screen text-gray-600">
              <p>V√©rification de la session Supabase...</p>
            </div>
          );

        if (!session)
          return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
              <div className="bg-white shadow-xl rounded-2xl p-8 w-full max-w-md space-y-6">
                <div className="flex items-center gap-3">
                  <UnlockIcon className="text-indigo-600" size={32} />
                  <div>
                    <h1 className="text-2xl font-bold text-gray-800">
                      {isRegistering ? "Cr√©er un compte" : "Connexion Supabase"}
                    </h1>
                    <p className="text-sm text-gray-500">
                      {isRegistering
                        ? "Choisissez un nom d'utilisateur (utilis√© pour la connexion) et un mot de passe."
                        : "Connectez-vous avec votre nom d'utilisateur et votre mot de passe pour acc√©der aux donn√©es transporteurs."}
                    </p>
                  </div>
                </div>

                {isRegistering ? (
                  <>
                    {registerError && (
                      <div className="bg-red-50 text-red-600 text-sm p-3 rounded">
                        {registerError}
                      </div>
                    )}
                    {registerMessage && (
                      <div className="bg-green-50 text-green-700 text-sm p-3 rounded">
                        {registerMessage}
                      </div>
                    )}
                    <form className="space-y-4" onSubmit={handleSignUp}>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Nom d'utilisateur
                        </label>
                        <input
                          type="text"
                          value={registerUsername}
                          onChange={(e) => setRegisterUsername(e.target.value)}
                          className="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-indigo-500"
                          placeholder="Votre identifiant"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Mot de passe
                        </label>
                        <div className="relative">
                          <input
                            type={isRegisterPasswordVisible ? "text" : "password"}
                            value={registerPassword}
                            onChange={(e) => setRegisterPassword(e.target.value)}
                            className="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-indigo-500 pr-12"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                          />
                          <button
                            type="button"
                            onClick={() =>
                              setIsRegisterPasswordVisible((visible) => !visible)
                            }
                            className="absolute inset-y-0 right-0 px-3 text-sm font-medium text-indigo-600 hover:text-indigo-800"
                            aria-label={
                              isRegisterPasswordVisible
                                ? "Masquer le mot de passe"
                                : "Afficher le mot de passe"
                            }
                          >
                            {isRegisterPasswordVisible ? "Masquer" : "Afficher"}
                          </button>
                        </div>
                      </div>
                      <button
                        type="submit"
                        className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50"
                        disabled={isCreatingAccount}
                      >
                        {isCreatingAccount ? "Cr√©ation en cours..." : "Cr√©er le compte"}
                      </button>
                    </form>
                    <p className="text-sm text-gray-600 text-center">
                      D√©j√† un compte ?
                      <button
                        type="button"
                        className="text-indigo-600 font-medium ml-1"
                        onClick={() => {
                          setIsRegistering(false);
                          setRegisterError("");
                          setRegisterMessage("");
                          setIsRegisterPasswordVisible(false);
                          setIsLoginPasswordVisible(false);
                        }}
                      >
                        Se connecter
                      </button>
                    </p>
                  </>
                ) : (
                  <>
                    {authError && (
                      <div className="bg-red-50 text-red-600 text-sm p-3 rounded">
                        {authError}
                      </div>
                    )}
                    <form className="space-y-4" onSubmit={handleLogin}>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Nom d'utilisateur
                        </label>
                        <input
                          type="text"
                          value={email}
                          onChange={(e) => setEmail(e.target.value)}
                          className="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-indigo-500"
                          placeholder="Votre nom d'utilisateur"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          Mot de passe
                        </label>
                        <div className="relative">
                          <input
                            type={isLoginPasswordVisible ? "text" : "password"}
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-indigo-500 pr-12"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                          />
                          <button
                            type="button"
                            onClick={() =>
                              setIsLoginPasswordVisible((visible) => !visible)
                            }
                            className="absolute inset-y-0 right-0 px-3 text-sm font-medium text-indigo-600 hover:text-indigo-800"
                            aria-label={
                              isLoginPasswordVisible
                                ? "Masquer le mot de passe"
                                : "Afficher le mot de passe"
                            }
                          >
                            {isLoginPasswordVisible ? "Masquer" : "Afficher"}
                          </button>
                        </div>
                      </div>
                      <button
                        type="submit"
                        className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50"
                        disabled={!email || !password}
                      >
                        Se connecter
                      </button>
                      <p className="text-xs text-gray-500 text-center">
                        Connectez-vous avec le nom d'utilisateur d√©fini lors de la cr√©ation du compte.
                      </p>
                    </form>
                    <p className="text-sm text-gray-600 text-center">
                      Pas encore de compte ?
                      <button
                        type="button"
                        className="text-indigo-600 font-medium ml-1"
                        onClick={() => {
                          setIsRegistering(true);
                          setAuthError("");
                          setIsRegisterPasswordVisible(false);
                          setIsLoginPasswordVisible(false);
                        }}
                      >
                        Cr√©er un compte
                      </button>
                    </p>
                  </>
                )}
              </div>
            </div>
          );

        if (isAdmin && adminPanelActive)
          return (
            <AdminDashboard
              session={session}
              onExit={() => setAdminPanelActive(false)}
              onDataUpdated={handleDataRefresh}
            />
          );

        if (loading)
          return (
            <div className="flex items-center justify-center h-screen text-gray-600">
              <p>Chargement des donn√©es depuis Supabase...</p>
            </div>
          );

        if (error)
          return (
            <div className="flex items-center justify-center h-screen text-red-600 text-center">
              <div>
                <p className="font-semibold mb-2">‚ùå Erreur :</p>
                <p>{error}</p>
              </div>
            </div>
          );

        return (
          <div className="max-w-7xl mx-auto p-6">
            {/* ======= HEADER ======= */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-8 flex items-center justify-between gap-6">
              <div className="flex items-center gap-3">
                <TruckIcon className="text-indigo-600" size={32} />
                <div>
                  <h1 className="text-3xl font-bold text-gray-800">
                    Optimiseur de Transporteur
                  </h1>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <span className="text-sm text-gray-700">{userDisplayName}</span>
                {isAdmin && (
                  <button
                    onClick={() => setAdminPanelActive(true)}
                    className="flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-800"
                  >
                    <SettingsIcon size={18} /> Mode admin
                  </button>
                )}
                <button
                  onClick={async () => {
                    await supabase.auth.signOut();
                  }}
                  className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900"
                >
                  <LogoutIcon size={18} /> D√©connexion
                </button>
              </div>
            </div>

            {/* ======= FORMULAIRE CRIT√àRES ======= */}
            <div className="grid md:grid-cols-3 gap-6 mb-8">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-lg font-semibold mb-4">Crit√®res</h2>

                {/* Bordereau */}
                <label className="block mb-1 text-sm font-medium text-gray-700">
                  Bordereau <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  placeholder={`23/${currentYear}/####`}
                  value={bordereau}
                  onChange={(e) => setBordereau(e.target.value)}
                  className="w-full border px-3 py-2 rounded mb-3 focus:ring-2 focus:ring-indigo-500"
                />

                {/* Type de camion */}
                <label className="block mb-2 text-sm font-medium text-gray-700">
                  Type de camion <span className="text-red-600">*</span>
                </label>
                <div className="flex gap-3 mb-4">
                  <label className={`px-3 py-2 border rounded cursor-pointer ${truckType === "non-specifie" ? "bg-indigo-50 border-indigo-400" : ""}`}>
                    <input
                      type="radio"
                      name="truck"
                      value="non-specifie"
                      checked={truckType === "non-specifie"}
                      onChange={(e) => setTruckType(e.target.value)}
                      className="mr-2"
                    />
                    Non sp√©cifi√© (choix auto)
                  </label>
                  <label className={`px-3 py-2 border rounded cursor-pointer ${truckType === "bache" ? "bg-indigo-50 border-indigo-400" : ""}`}>
                    <input
                      type="radio"
                      name="truck"
                      value="bache"
                      checked={truckType === "bache"}
                      onChange={(e) => setTruckType(e.target.value)}
                      className="mr-2"
                    />
                    Bach√©
                  </label>
                  <label className={`px-3 py-2 border rounded cursor-pointer ${truckType === "plateau" ? "bg-indigo-50 border-indigo-400" : ""}`}>
                    <input
                      type="radio"
                      name="truck"
                      value="plateau"
                      checked={truckType === "plateau"}
                      onChange={(e) => setTruckType(e.target.value)}
                      className="mr-2"
                    />
                    Plateau
                  </label>
                </div>

                <button
                  onClick={handleSearch}
                  className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 flex items-center justify-center gap-2 disabled:opacity-60"
                  disabled=
                    {(!BORDEREAU_REGEX.test(bordereau) ||
                      !truckType ||
                      !selectedDepts.length ||
                      isSearching ||
                      isSavingLog)}
                >
                  {isSearching ? (
                    "Recherche..."
                  ) : (
                    <>
                      <SearchIcon size={18} /> Rechercher
                    </>
                  )}
                </button>
              </div>

              {/* ======= LISTE DES D√âPARTEMENTS ======= */}
              <div className="md:col-span-2 bg-white rounded-xl shadow-lg p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-semibold">D√©partements</h2>
                  <button
                    onClick={() => {
                      setSelectedDepts([]);
                    }}
                    className="text-sm text-indigo-600 hover:text-indigo-800"
                  >
                    Tout d√©cocher
                  </button>
                </div>

                <div className="relative mb-4">
                  <SearchIcon
                    size={16}
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                  />
                  <input
                    type="text"
                    value={departmentSearch}
                    onChange={(event) => setDepartmentSearch(event.target.value)}
                    onKeyDown={handleDepartmentSearchKeyDown}
                    placeholder="Rechercher un d√©partement (ex: 75)"
                    className="w-full border border-gray-300 rounded-lg py-2 pl-9 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                    autoComplete="off"
                  />
                </div>

                <div className="max-h-80 overflow-y-auto space-y-2">
                  {filteredDepartments.length === 0 ? (
                    <p className="text-sm text-gray-500">
                      Aucun d√©partement ne correspond √† la recherche.
                    </p>
                  ) : (
                    filteredDepartments.map((dept) => {
                      const isSelected = selectedDepts.includes(dept.id);

                      return (
                        <div
                          key={dept.id}
                          className={`flex items-center justify-between bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-400 ${isSelected ? "ring-2 ring-indigo-400" : ""}`}
                          role="button"
                          tabIndex={0}
                          onClick={() => toggleDepartmentSelection(dept.id)}
                          onKeyDown={(event) => {
                            if (event.key === "Enter" || event.key === " ") {
                              event.preventDefault();
                              toggleDepartmentSelection(dept.id);
                            }
                          }}
                        >
                          <div className="flex items-center gap-3">
                            <input
                              type="checkbox"
                              checked={isSelected}
                              onClick={(event) => event.stopPropagation()}
                              onChange={() => toggleDepartmentSelection(dept.id)}
                              className="text-indigo-600"
                            />
                            <span className="font-mono text-sm bg-indigo-100 px-2 py-1 rounded font-semibold">
                              {dept.code}
                            </span>
                            <span>{dept.name}</span>
                          </div>
                          <span className="text-sm text-gray-500">{dept.km} km</span>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            </div>

            {/* ======= SECTION TRAJET ======= */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
              <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                <div className="flex items-center gap-3">
                  <RouteIcon className="text-indigo-600" size={28} />
                  <h2 className="text-xl font-bold text-gray-800">Trajet</h2>
                </div>
                {optimalRoute.length === 2 && (
                  <button
                    onClick={() => setIsRouteReversed((prev) => !prev)}
                    className={`inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-semibold transition-colors ${
                      isRouteReversed
                        ? "bg-indigo-600 text-white hover:bg-indigo-700"
                        : "bg-indigo-50 text-indigo-700 hover:bg-indigo-100"
                    }`}
                    type="button"
                  >
                    <RefreshIcon size={16} />
                    Inverser l'ordre des d√©partements
                  </button>
                )}
              </div>
              {selectedDepts.length === 0 ? (
                <p className="text-gray-500">S√©lectionnez des d√©partements pour visualiser l'ordre de livraison.</p>
              ) : optimalRoute.length === 0 ? (
                <p className="text-gray-500">Impossible de calculer l'itin√©raire.</p>
              ) : (
                <ol className="space-y-2 text-sm text-gray-700">
                  <li className="flex items-center gap-2">
                    <span className="inline-flex items-center justify-center w-6 h-6 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                      0
                    </span>
                    <div>
                      <strong>D√©part :</strong> Sprimont
                    </div>
                  </li>
                  {optimalRoute.map((dept, index) => (
                    <li key={dept.id} className="flex items-start gap-2">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">
                        {index + 1}
                      </span>
                      <div>
                        <div className="font-semibold">
                          {dept.code} - {dept.name}
                        </div>
                      <div className="text-xs text-gray-500">{dept.km} km depuis Sprimont</div>
                    </div>
                  </li>
                ))}
              </ol>
              )}

              {routeMetrics.loading && (
                <p className="mt-3 text-sm text-indigo-600">
                  Calcul du d√©tour en cours via OpenRouteService...
                </p>
              )}

              {routeMetrics.error && (
                <p className="mt-3 text-sm text-red-600">
                  {routeMetrics.error}
                </p>
              )}

              {!routeMetrics.error && !routeMetrics.loading &&
                routeMetrics.totalDistanceKm > 0 && (
                  <p className="mt-3 text-sm text-gray-700">
                    Trajet estim√© : {routeMetrics.totalDistanceKm.toFixed(2)} km (d√©tour
                    : {routeMetrics.detourKm.toFixed(2)} km)
                  </p>
                )}
            </div>

            {/* ======= SECTION TRANSPORTEURS ======= */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-800">Tarif transporteur</h2>
                <button
                  onClick={() => setShowTransporters((prev) => !prev)}
                  className="text-sm text-indigo-600 hover:text-indigo-800"
                >
                  {showTransporters ? "Voir moins" : "Voir plus"}
                </button>
              </div>

              {showTransporters && (
                <>
                  {selectedDepts.length === 0 ? (
                    <p className="text-gray-500">S√©lectionnez un ou plusieurs d√©partements pour afficher les tarifs.</p>
                  ) : (
                    <div className="space-y-4">
                      {selectedDepartmentList.map((dept) => {
                        const deptTransporters = transporters
                          .map((t) => {
                            const rate = t.rates.find((r) => r.deptId === dept.id);
                            if (!rate) return null;
                            return { transporter: t, rate };
                          })
                          .filter(Boolean);

                        return (
                          <div key={dept.id} className="border rounded p-4">
                            <div className="flex flex-col gap-1 mb-3 md:flex-row md:items-center md:justify-between">
                              <h3 className="font-semibold text-lg text-gray-800">
                                {dept.code} - {dept.name}
                              </h3>
                              <span className="text-sm text-gray-500">{dept.km} km depuis Sprimont</span>
                            </div>
                            {deptTransporters.length === 0 ? (
                              <p className="text-sm text-gray-500">
                                Aucun tarif disponible pour ce d√©partement.
                              </p>
                            ) : (
                              <ul className="text-sm text-gray-700 divide-y divide-gray-200">
                                {deptTransporters.map(({ transporter, rate }) => (
                                  <li key={transporter.id} className="py-2 first:pt-0">
                                    <div className="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                                      <span className="font-semibold text-gray-800">{transporter.name}</span>
                                      {transporter.hasBreakOfCharge && (
                                        <span className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded self-start md:self-auto">
                                          Rupture de charge : {transporter.breakOfChargeCost}‚Ç¨
                                        </span>
                                      )}
                                    </div>
                                    <div className="text-sm text-gray-600">
                                      <span className="mr-3">Bach√© {formatTruckRate(rate.tarpsCost)}</span>
                                      <span>Plateau {formatTruckRate(rate.flatbedCost)}</span>
                                    </div>
                                  </li>
                                ))}
                              </ul>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </>
              )}
            </div>

            {/* ======= R√âSULTATS DU CALCUL ======= */}
            {hasSearched && bestTransporters.length > 0 && (
              <div
                ref={resultsRef}
                id="resultats"
                className="bg-white rounded-xl shadow-lg p-6 mb-8"
              >
                <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <CalculatorIcon className="text-green-600" size={28} />
                    <h2 className="text-2xl font-bold text-gray-800">R√©sultats du Calcul</h2>
                  </div>
                  <button
                    onClick={handleValidate}
                    className="inline-flex items-center justify-center px-4 py-2 rounded-md bg-green-600 text-white text-sm font-semibold hover:bg-green-700 disabled:opacity-60 disabled:cursor-not-allowed"
                    disabled={
                      isSavingLog ||
                      selectedResultIndex === null ||
                      !bestTransporters.length
                    }
                  >
                    {isSavingLog ? "Validation..." : "Valider"}
                  </button>
                </div>

                {validationError && (
                  <div className="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                    {validationError}
                  </div>
                )}

                {validationMessage && (
                  <div className="mb-4 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700">
                    {validationMessage}
                  </div>
                )}

                {bestTransporters.slice(0, 3).map((result, index) => {
                  const isSelected = selectedResultIndex === index;
                  const reasonValue = reasons[index] || "";

                  return (
                    <div
                      key={result.transporter.id}
                      className={`p-6 rounded-lg border-2 mb-4 transition-colors ${
                        isSelected
                          ? "border-indigo-500 bg-indigo-50 ring-2 ring-indigo-200"
                          : index === 0
                          ? "bg-green-50 border-green-500"
                          : "bg-gray-50 border-gray-200"
                      }`}
                    >
                      <div className="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                        <div className="flex-1">
                          <div className="flex justify-between mb-3">
                            <div className="flex items-center gap-3">
                              {index === 0 && !isSelected && (
                                <span className="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                                  ‚≠ê MEILLEUR CHOIX
                                </span>
                              )}
                              {isSelected && (
                                <span className="bg-indigo-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                                  ‚úÖ S√âLECTIONN√â
                                </span>
                              )}
                              <h3 className="text-xl font-bold text-gray-800">
                                {result.transporter.name}
                              </h3>
                            </div>
                            <div className="text-right">
                              <div className="text-3xl font-bold text-indigo-600">
                                {result.totalCost.toFixed(2)}‚Ç¨
                              </div>
                              <div className="text-sm text-gray-500">Co√ªt total</div>
                            </div>
                          </div>
                          <div className="space-y-1 text-sm text-gray-700">
                            {result.details.map((d, i) => (
                              <p key={i}>‚Ä¢ {d}</p>
                            ))}
                          </div>
                        </div>
                        <div className="w-full md:w-64">
                          <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                            <input
                              type="checkbox"
                              className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                              checked={isSelected}
                              onChange={() => {
                                setSelectedResultIndex((prev) =>
                                  prev === index ? null : index
                                );
                                setValidationError("");
                                setValidationMessage("");
                              }}
                            />
                            Utiliser ce transporteur
                          </label>
                          <label className="block text-xs text-gray-500 mt-4 mb-1">
                            Raison si non s√©lectionn√©
                          </label>
                          <select
                            value={reasonValue}
                            onChange={(e) => {
                              const { value } = e.target;
                              setReasons((prev) => {
                                const next = { ...prev };
                                if (value) {
                                  next[index] = value;
                                } else {
                                  delete next[index];
                                }
                                return next;
                              });
                              setValidationError("");
                              setValidationMessage("");
                            }}
                            className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                          >
                            <option value="">S√©lectionner une raison</option>
                            {NON_SELECTION_REASONS.map((reason) => (
                              <option key={reason} value={reason}>
                                {reason}
                              </option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            {hasSearched && selectedDepts.length > 0 && bestTransporters.length === 0 && (
              <div
                ref={resultsRef}
                id="resultats"
                className="bg-white rounded-xl shadow-lg p-6 mb-8 text-gray-600"
              >
                <h2 className="text-xl font-semibold mb-2">Tarifs indisponibles</h2>
                <p>
                  Aucun transporteur ne propose actuellement de tarifs complets pour tous les
                  d√©partements s√©lectionn√©s. Essayez de modifier votre s√©lection ou contactez un
                  administrateur pour mettre √† jour la base de donn√©es.
                </p>
              </div>
            )}

            <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
              <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                <div className="flex items-center gap-2">
                  <h2 className="text-xl font-bold text-gray-800">Historique des recherches</h2>
                  {logsLoading && <span className="text-sm text-gray-500">Chargement...</span>}
                </div>
                <div className="relative w-full md:w-80">
                  <SearchIcon
                    size={16}
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                  />
                  <input
                    type="text"
                    value={logSearch}
                    onChange={(e) => setLogSearch(e.target.value)}
                    placeholder="Rechercher par bordereau"
                    className="w-full border border-gray-300 rounded-lg py-2 pl-9 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                    autoComplete="off"
                  />
                </div>
              </div>

              {logsError && (
                <div className="bg-red-50 text-red-600 text-sm p-3 rounded mb-4">{logsError}</div>
              )}

              {!logsLoading && logs.length === 0 ? (
                <p className="text-sm text-gray-500">
                  Aucune recherche enregistr√©e pour le moment. Lancez une recherche pour voir les
                  derniers r√©sultats ici.
                </p>
              ) : !logsLoading && logs.length > 0 && filteredLogs.length === 0 ? (
                <p className="text-sm text-gray-500">
                  Aucun bordereau ne correspond √† la recherche. Essayez un autre terme.
                </p>
              ) : (
                <>
                  <ul className="space-y-4">
                    {visibleLogs.map((log) => (
                      <li key={log.id} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex items-center justify-between text-sm text-gray-500 mb-2">
                          <span className="font-medium text-gray-700">{log.bordereau}</span>
                          <span>{formatLogDate(log.date_recherche)}</span>
                        </div>
                        {(() => {
                          const differenceValue = formatDifferenceValue(
                            log.difference
                          );
                          if (differenceValue === null) {
                            return null;
                          }
                          return (
                            <p className="text-sm text-gray-700">
                              <span className="font-semibold">√âcart :</span> {differenceValue.toFixed(2)}‚Ç¨
                            </p>
                          );
                        })()}
                        {log.departements && (
                          <p className="text-sm text-gray-700">
                            <span className="font-semibold">D√©partements :</span> {log.departements}
                          </p>
                        )}
                        {log.attributs && (
                          <p className="text-sm text-gray-700">
                            <span className="font-semibold">Type :</span> {log.attributs}
                          </p>
                        )}
                        {log.resultat && (
                          <p className="text-sm text-gray-700">
                            <span className="font-semibold">R√©sultat :</span> {log.resultat}
                          </p>
                        )}
                        {([1, 2, 3].some((idx) =>
                          log[`choix_${idx}`] ||
                          log[`cout_${idx}`] ||
                          log[`raison_${idx}`]
                        )) && (
                          <ul className="mt-3 space-y-2 text-sm text-gray-600">
                            {[1, 2, 3].map((idx) => {
                              const choice = log[`choix_${idx}`];
                              const cost = log[`cout_${idx}`];
                              const reason = log[`raison_${idx}`];
                              const display =
                                formatChoiceDisplay(choice, cost) ||
                                (reason ? "‚Äî" : null);

                              if (!display && !reason) {
                                return null;
                              }

                              const prefix = idx === 1 ? "1Ô∏è‚É£" : idx === 2 ? "2Ô∏è‚É£" : "3Ô∏è‚É£";

                              return (
                                <li
                                  key={idx}
                                  className="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                                >
                                  <div className="font-medium text-gray-700">
                                    {prefix} {display}
                                  </div>
                                  {reason && (
                                    <p className="mt-1 text-xs text-gray-500">
                                      <span className="font-semibold text-gray-600">
                                        Raison :
                                      </span>{" "}
                                      {reason}
                                    </p>
                                  )}
                                </li>
                              );
                            })}
                          </ul>
                        )}
                      </li>
                    ))}
                  </ul>

                  {filteredLogs.length > 5 && (
                    <div className="mt-4">
                      <button
                        onClick={() => setShowAllLogs((prev) => !prev)}
                        className="text-sm text-indigo-600 hover:text-indigo-800"
                      >
                        {showAllLogs ? "Voir moins" : "Voir plus"}
                      </button>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        );
      }

      /********************************************
       *  RENDU FINAL
       ********************************************/
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<TransportOptimizer />);
    </script>
  </body>
</html>
