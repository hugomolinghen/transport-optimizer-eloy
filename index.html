<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Optimiseur de Transporteur</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Lucide React (UMD) -->
    <script src="https://unpkg.com/lucide-react@0.394.0/dist/lucide-react.umd.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Babel (pour ex√©cuter le JSX directement dans le navigateur) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      // ========= Correctifs de robustesse =========
      // 1) Lucide UMD peut ne pas exposer "lucideReact" selon la version/CDN.
      //    On prend la r√©f√©rence globale si dispo, sinon on fournit des composants vides pour √©viter les crashs.
      const LUCIDE_GLOBAL = (typeof window !== 'undefined' && (window.lucideReact || window.LucideReact)) || {};
      const NullIcon = (props) => null;
      const {
        Truck = NullIcon,
        Calculator = NullIcon,
        AlertCircle = NullIcon,
        MapPin = NullIcon,
        Search = NullIcon,
      } = LUCIDE_GLOBAL;

      const { useState, useMemo, useEffect } = React;

      const SUPABASE_URL = 'https://eayhqksztfhyxqhrrnkk.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVheWhxa3N6dGZoeXhxaHJybmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTQwMzksImV4cCI6MjA3Nzc3MDAzOX0.AsWKSQDa9MDpsmvP6i4LOwBJevQfzUyImzt2_8D-o18';
      const supabaseClient =
        typeof window !== 'undefined' && window.supabase
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

      // --- Donn√©es de base ---
      // Calcul d'itin√©raire optimal (plus proche -> plus √©loign√©, en terminant par le plus loin)
      const calculateOptimalRoute = (selectedDeptIds, departments) => {
        if (selectedDeptIds.length === 0) return [];
        const toNumber = (value) => {
          const numeric = Number(value);
          return Number.isFinite(numeric) ? numeric : 0;
        };
        const selectedDepts = selectedDeptIds
          .map(id => departments.find(d => d.id === id))
          .filter(Boolean);
        if (selectedDepts.length <= 1) return selectedDepts;
        const farthest = selectedDepts.reduce((max, dept) => (toNumber(dept.km) > toNumber(max.km) ? dept : max));
        const others = selectedDepts
          .filter(d => d.id !== farthest.id)
          .sort((a, b) => toNumber(a.km) - toNumber(b.km));
        return [...others, farthest];
      };

      // Helpers
      const currentYear = new Date().getFullYear();
      const BORDEREAU_REGEX = new RegExp(`^23\/${currentYear}\/([1-9]\d{0,3})$`);

      function TransportOptimizer() {
        const [departments, setDepartments] = useState([]);
        const [departmentsLoading, setDepartmentsLoading] = useState(true);
        const [departmentsError, setDepartmentsError] = useState('');

        // Deux types de camions: bach√© (tarps) et plateau (flatbed)
        const [truckType, setTruckType] = useState(''); // 'tarps' | 'flatbed'

        // Bordereau obligatoire
        const [bordereau, setBordereau] = useState('');
        const [bordereauTouched, setBordereauTouched] = useState(false);

        const [transporters, setTransporters] = useState([]);
        const [transportersLoading, setTransportersLoading] = useState(true);
        const [transportersError, setTransportersError] = useState('');

        const [selectedDepts, setSelectedDepts] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [hasSearched, setHasSearched] = useState(false);

        const [user, setUser] = useState(null);
        const [loginInput, setLoginInput] = useState('');
        const [password, setPassword] = useState('');
        const [authError, setAuthError] = useState('');
        const [authLoading, setAuthLoading] = useState(false);

        useEffect(() => {
          let isMounted = true;

          const loadDepartments = async () => {
            if (!supabaseClient) {
              if (!isMounted) return;
              setDepartments([]);
              setDepartmentsError('Client Supabase non initialis√©.');
              setDepartmentsLoading(false);
              return;
            }

            setDepartmentsLoading(true);
            const tableCandidates = ['departements', 'd√©partements'];
            let fetchedData = [];
            let fetchError = null;

            for (const tableName of tableCandidates) {
              const { data, error } = await supabaseClient
                .from(tableName)
                .select('id, code, name, km')
                .order('code', { ascending: true });

              if (!error) {
                fetchedData = data || [];
                fetchError = null;
                break;
              }

              fetchError = error;
              console.warn(`[Departements] Tentative sur ${tableName} √©chou√©e`, error);
            }

            if (!isMounted) return;

            if (fetchError) {
              console.error('[Departements] Chargement impossible', fetchError);
              setDepartments([]);
              setDepartmentsError("Impossible de charger les d√©partements depuis Supabase.");
            } else {
              setDepartments(Array.isArray(fetchedData) ? fetchedData : []);
              setDepartmentsError('');
            }

            setDepartmentsLoading(false);
          };

          loadDepartments();

          return () => {
            isMounted = false;
          };
        }, []);

        useEffect(() => {
          setSelectedDepts(prev => prev.filter(id => departments.some(dept => dept.id === id)));
        }, [departments]);

        const departmentMap = useMemo(() => {
          const map = new Map();
          departments.forEach(dept => {
            map.set(dept.id, dept);
          });
          return map;
        }, [departments]);

        const departmentByCode = useMemo(() => {
          const map = new Map();
          departments.forEach(dept => {
            map.set(dept.code, dept);
          });
          return map;
        }, [departments]);

        useEffect(() => {
          if (!supabaseClient) {
            setTransporters([]);
            setTransportersError('Client Supabase non initialis√©.');
            setTransportersLoading(false);
            return;
          }

          if (departments.length === 0) {
            setTransporters([]);
            setTransportersError('');
            setTransportersLoading(false);
            return;
          }

          let isMounted = true;

          const loadTransporters = async () => {
            setTransportersLoading(true);
            const { data, error } = await supabaseClient
              .from('v_tarifs_complets')
              .select('departement_code, transporteur_nom, prix_bache, prix_plateau, km_depuis_sprimont')
              .order('transporteur_nom', { ascending: true })
              .order('departement_code', { ascending: true });

            if (!isMounted) return;

            if (error) {
              console.error('[Transporteurs] Chargement impossible', error);
              setTransporters([]);
              setTransportersError("Impossible de charger les transporteurs depuis Supabase.");
            } else {
              const transporterMap = new Map();
              const toNumber = (value) => {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? numeric : 0;
              };

              (data || []).forEach(row => {
                const dept = departmentByCode.get(row.department_code);
                if (!dept) return;

                const transporterName = row.transporteur_nom || 'Transporteur';
                if (!transporterMap.has(transporterName)) {
                  transporterMap.set(transporterName, {
                    id: transporterName,
                    name: transporterName,
                    hasBreakOfCharge: false,
                    breakOfChargeCost: 0,
                    rates: []
                  });
                }

                const transporter = transporterMap.get(transporterName);
                transporter.rates.push({
                  deptId: dept.id,
                  departmentCode: dept.code,
                  tarpsCost: toNumber(row.prix_bache),
                  flatbedCost: toNumber(row.prix_plateau),
                  kmFromSprimont: toNumber(row.km_depuis_sprimont)
                });
              });

              const normalizedTransporters = Array.from(transporterMap.values()).map((transporter) => ({
                ...transporter,
                rates: transporter.rates
                  .slice()
                  .sort((a, b) => {
                    const codeA = a.departmentCode || '';
                    const codeB = b.departmentCode || '';
                    return codeA.localeCompare(codeB, 'fr', { numeric: true, sensitivity: 'base' });
                  })
              }));

              setTransporters(normalizedTransporters);
              setTransportersError('');
            }

            setTransportersLoading(false);
          };

          loadTransporters();

          return () => {
            isMounted = false;
          };
        }, [departments, departmentByCode]);

        useEffect(() => {
          if (!supabaseClient) return;

          let isMounted = true;

          supabaseClient.auth.getSession().then(({ data }) => {
            if (!isMounted) return;
            setUser(data.session?.user ?? null);
          });

          const {
            data: { subscription }
          } = supabaseClient.auth.onAuthStateChange((_event, session) => {
            if (!isMounted) return;
            setUser(session?.user ?? null);
          });

          return () => {
            isMounted = false;
            subscription?.unsubscribe();
          };
        }, []);

        const userDisplayName =
          user?.user_metadata?.identifiant ||
          user?.email ||
          'Utilisateur';

        const handleLogin = async (event) => {
          event.preventDefault();
          setAuthError('');
          const identifier = loginInput.trim();

          if (!identifier || !password) {
            setAuthError('Veuillez saisir un identifiant et un mot de passe.');
            return;
          }

          if (!supabaseClient) {
            setAuthError('Client Supabase non initialis√©.');
            return;
          }

          setAuthLoading(true);
          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: identifier,
            password
          });

          if (error) {
            setAuthError(error.message);
          } else {
            setLoginInput('');
            setPassword('');
            setAuthError('');
            setUser(data?.user ?? null);
          }

          setAuthLoading(false);
        };

        const handleLogout = async () => {
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          setUser(null);
          setLoginInput('');
          setPassword('');
          setAuthError('');
        };

        const filteredDepartments = useMemo(() => {
          return departments.filter(d =>
            d.name.toLowerCase().includes(searchTerm.toLowerCase()) || d.code.includes(searchTerm)
          );
        }, [departments, searchTerm]);

        const optimalRoute = useMemo(() => calculateOptimalRoute(selectedDepts, departments), [selectedDepts, departments]);

        const calculateBestTransporter = useMemo(() => {
          if (selectedDepts.length === 0 || !truckType || transporters.length === 0) return [];
          const route = optimalRoute;

          const results = transporters.map(transporter => {
            let totalCost = 0;
            const details = [];

            if (transporter.hasBreakOfCharge && route.length > 1) {
              totalCost += transporter.breakOfChargeCost;
              details.push(`Rupture de charge: ${transporter.breakOfChargeCost}‚Ç¨`);

              const farthestDept = route[route.length - 1];
              const farthestRate = transporter.rates.find(r => r.deptId === farthestDept.id);
              if (farthestRate) {
                const cost = truckType === 'tarps' ? farthestRate.tarpsCost : farthestRate.flatbedCost;
                totalCost += cost;
                details.push(`${farthestDept.name} (${farthestDept.km}km): ${cost}‚Ç¨`);
              }

              for (let i = 0; i < route.length - 1; i++) {
                const dept = route[i];
                const rate = transporter.rates.find(r => r.deptId === dept.id);
                if (rate) {
                  const base = truckType === 'tarps' ? rate.tarpsCost : rate.flatbedCost;
                  const adjustedCost = base * 0.7; // r√©duction apr√®s rupture
                  totalCost += adjustedCost;
                  details.push(`${dept.name} (depuis rupture): ${adjustedCost.toFixed(2)}‚Ç¨`);
                }
              }
            } else {
              route.forEach((dept, index) => {
                const rate = transporter.rates.find(r => r.deptId === dept.id);
                if (rate) {
                  const cost = truckType === 'tarps' ? rate.tarpsCost : rate.flatbedCost;
                  totalCost += cost;
                  details.push(`${index + 1}. ${dept.name} (${dept.km}km): ${cost}‚Ç¨`);
                }
              });
            }

            return { transporter, totalCost, details };
          });

          return results.sort((a, b) => a.totalCost - b.totalCost);
        }, [transporters, selectedDepts, optimalRoute, truckType]);

        // Validation bordereau
        const isBordereauValid = BORDEREAU_REGEX.test(bordereau);

        // Recherche (calcul + log)
        const onSearch = () => {
          setBordereauTouched(true);
          if (!isBordereauValid || !truckType || selectedDepts.length === 0) return;
          setHasSearched(true);
        };

        // ================== Petit panneau de tests (auto-tests) ==================
        const [selfTests, setSelfTests] = useState([]);
        useEffect(() => {
          const YEAR = new Date().getFullYear();
          const dataset = departments;
          const results = [];

          const sampleShort = `23/${YEAR}/1`;
          const sampleLong = `23/${YEAR}/1234`;
          const sampleInvalid = `23/${YEAR}/12345`;

          const validShort = BORDEREAU_REGEX.test(sampleShort);
          const validLong = BORDEREAU_REGEX.test(sampleLong);
          const invalidLong = !BORDEREAU_REGEX.test(sampleInvalid);

          results.push({ name: 'Bordereau valide court', pass: validShort, expected: true, got: validShort });
          results.push({ name: 'Bordereau valide 4 chiffres', pass: validLong, expected: true, got: validLong });
          results.push({ name: 'Bordereau invalide 5 chiffres', pass: invalidLong, expected: true, got: invalidLong });

          if (dataset.length >= 2) {
            const first = dataset[0];
            const last = dataset[dataset.length - 1];
            const route = calculateOptimalRoute([first.id, last.id], dataset);
            const farthestKm = route.reduce((max, dept) => {
              const km = Number(dept?.km) || 0;
              return km > max ? km : max;
            }, 0);
            const lastKm = Number(route[route.length - 1]?.km) || 0;
            const endsWithFarthest = route.length >= 1 && Math.abs(lastKm - farthestKm) < 1e-6;
            results.push({
              name: 'Itin√©raire termine par plus √©loign√©',
              pass: endsWithFarthest,
              expected: true,
              got: endsWithFarthest
            });
          }

          const allPass = results.every(t => t.pass);
          setSelfTests(results.map(t => ({ name: t.name, result: t.pass, expected: t.expected, got: t.got })));
          console.log('[SelfTests]', { pass: allPass, details: results });
        }, [departments]);

        if (!user) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
              <div className="bg-white shadow-xl rounded-2xl p-8 w-full max-w-md">
                <div className="flex items-center gap-3 mb-6">
                  <Truck className="text-indigo-600" size={32} />
                  <div>
                    <h1 className="text-2xl font-bold text-gray-800">Connexion requise</h1>
                    <p className="text-sm text-gray-500">
                      Veuillez saisir votre identifiant Supabase (email) et votre mot de passe pour acc√©der √† l'outil.
                    </p>
                  </div>
                </div>
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Identifiant</label>
                    <input
                      type="text"
                      value={loginInput}
                      onChange={(e) => setLoginInput(e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                      autoFocus
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  {authError && <p className="text-sm text-red-600">{authError}</p>}
                  <button
                    type="submit"
                    className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-60"
                    disabled={authLoading}
                  >
                    {authLoading ? 'Connexion...' : 'Se connecter'}
                  </button>
                </form>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen p-8">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                  <div className="flex items-center gap-3">
                    <Truck className="text-indigo-600" size={32} />
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800">Optimiseur de Transporteur</h1>
                      <p className="text-sm text-gray-500">Depuis Eloywater SA, Sprimont, Belgique</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3 self-end md:self-auto">
                    <div className="text-sm text-gray-500">
                      Connect√© en tant que <span className="font-semibold text-gray-700">{userDisplayName}</span>
                    </div>
                    <button
                      onClick={handleLogout}
                      className="px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-gray-50"
                    >
                      D√©connexion
                    </button>
                  </div>
                </div>
                <p className="text-gray-600 mt-6">Trouvez automatiquement le transporteur le moins cher avec itin√©raire optimis√©</p>
              </div>

              {/* Zone crit√®res & s√©lection */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                {/* Crit√®res globaux */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Crit√®res</h2>

                  {/* Bordereau */}
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bordereau <span className="text-red-600">*</span></label>
                  <input
                    type="text"
                    placeholder={`23/${currentYear}/####`}
                    value={bordereau}
                    onChange={(e) => setBordereau(e.target.value)}
                    onBlur={() => setBordereauTouched(true)}
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 mb-2 ${
                      bordereauTouched && !isBordereauValid ? 'border-red-400 focus:ring-red-300' : 'focus:ring-indigo-500'
                    }`}
                  />
                  {bordereauTouched && !isBordereauValid && (
                    <div className="flex items-center gap-2 text-red-600 text-sm mb-4">
                      <AlertCircle size={16} />
                      <span>Format attendu : <code className="bg-red-50 px-1 rounded">23/{currentYear}/n</code> (n = 1 √† 4 chiffres).</span>
                    </div>
                  )}

                  {/* Type de camion */}
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type de camion <span className="text-red-600">*</span></label>
                  <div className="flex items-center gap-3 mb-4">
                    <label className={`px-3 py-2 border rounded-lg cursor-pointer ${truckType === 'tarps' ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}`}>
                      <input type="radio" name="truckType" value="tarps" className="mr-2" onChange={(e) => setTruckType(e.target.value)} checked={truckType==='tarps'} />
                      Bach√©
                    </label>
                    <label className={`px-3 py-2 border rounded-lg cursor-pointer ${truckType === 'flatbed' ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}`}>
                      <input type="radio" name="truckType" value="flatbed" className="mr-2" onChange={(e) => setTruckType(e.target.value)} checked={truckType==='flatbed'} />
                      Plateau
                    </label>
                  </div>

                  <button
                    onClick={onSearch}
                    className="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 disabled:opacity-60"
                    disabled={!isBordereauValid || !truckType || selectedDepts.length === 0 || departmentsLoading || transportersLoading || transporters.length === 0}
                    title={!isBordereauValid
                      ? 'Bordereau requis'
                      : !truckType
                      ? 'Type de camion requis'
                      : selectedDepts.length === 0
                      ? 'S√©lectionnez au moins un d√©partement'
                      : departmentsLoading
                      ? 'Chargement des d√©partements en cours'
                      : transportersLoading
                      ? 'Chargement des transporteurs en cours'
                      : transporters.length === 0
                      ? 'Aucun transporteur disponible'
                      : 'Lancer la recherche'}
                  >
                    <Search size={18} /> Rechercher
                  </button>

                  {(!isBordereauValid || !truckType || selectedDepts.length === 0) && (
                    <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2 mt-3">
                      Renseignez le bordereau, le type de camion et au moins un d√©partement pour activer la recherche.
                    </p>
                  )}
                </div>

                {/* S√©lection des D√©partements */}
                <div className="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">D√©partements √† livrer</h2>

                  <input
                    type="text"
                    placeholder="Rechercher (nom ou code)..."
                    className="w-full px-4 py-2 border rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    disabled={departmentsLoading}
                  />

                  {departmentsError && !departmentsLoading && (
                    <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 mb-4">
                      {departmentsError}
                    </p>
                  )}

                  <div className="mb-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                    <strong>S√©lectionn√©s:</strong> {selectedDepts.length} d√©partement(s)
                  </div>

                  {departmentsLoading ? (
                    <p className="text-sm text-gray-500">Chargement des d√©partements...</p>
                  ) : (
                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto">
                      {filteredDepartments.length === 0 ? (
                        <p className="text-sm text-gray-500 col-span-full">Aucun d√©partement ne correspond √† la recherche.</p>
                      ) : (
                        filteredDepartments.map(dept => (
                          <div key={dept.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div className="flex items-center gap-3 flex-1">
                              <input
                                type="checkbox"
                                checked={selectedDepts.includes(dept.id)}
                                onChange={(e) => {
                                  if (departmentsLoading) return;
                                  if (e.target.checked) setSelectedDepts([...selectedDepts, dept.id]);
                                  else setSelectedDepts(selectedDepts.filter(id => id !== dept.id));
                                }}
                                className="w-4 h-4 text-indigo-600"
                                disabled={departmentsLoading}
                              />
                              <span className="font-mono text-sm bg-indigo-100 px-2 py-1 rounded font-semibold">{dept.code}</span>
                              <span className="font-medium flex-1">{dept.name}</span>
                              <span className="text-sm text-gray-500 font-mono">{dept.km} km</span>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Gestion des Transporteurs */}
              <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Transporteurs</h2>

                {departmentsError && (
                  <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 mb-4">
                    {departmentsError}
                  </p>
                )}

                {transportersError && !transportersLoading && (
                  <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 mb-4">
                    {transportersError}
                  </p>
                )}

                {departmentsLoading ? (
                  <p className="text-sm text-gray-500">Chargement des d√©partements...</p>
                ) : transportersLoading ? (
                  <p className="text-sm text-gray-500">Chargement des transporteurs...</p>
                ) : (
                  <>
                    <p className="text-sm text-gray-500 mb-4">
                      Tarifs synchronis√©s depuis Supabase (vue{' '}
                      <code className="bg-gray-100 px-1 rounded">v_tarifs_complets</code>).
                    </p>
                    <div className="space-y-4 max-h-[30rem] overflow-y-auto pr-1">
                      {transporters.length === 0 ? (
                        <p className="text-gray-600">Aucun transporteur disponible.</p>
                      ) : (
                        transporters.map(transporter => (
                          <div key={transporter.id} className="border rounded-lg p-4">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <h3 className="font-bold text-gray-800">{transporter.name}</h3>
                                {transporter.hasBreakOfCharge && (
                                  <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">
                                    Rupture: {transporter.breakOfChargeCost}‚Ç¨
                                  </span>
                                )}
                              </div>
                            </div>
                            {selectedDepts.length === 0 ? (
                              <p className="text-sm text-gray-500">
                                S√©lectionnez des d√©partements pour visualiser les tarifs estim√©s.
                              </p>
                            ) : (
                              <ul className="text-sm text-gray-600 space-y-2">
                                {selectedDepts.map(deptId => {
                                  const dept = departmentMap.get(deptId);
                                  if (!dept) return null;
                                  const rate = transporter.rates.find(r => r.deptId === deptId);
                                  if (!rate) return null;
                                  return (
                                    <li
                                      key={`${transporter.id}-${deptId}`}
                                      className="flex flex-wrap items-center gap-2 border-b last:border-b-0 pb-2 last:pb-0"
                                    >
                                      <span className="font-semibold">
                                        {dept.code} - {dept.name}
                                      </span>
                                      <span className="text-xs text-gray-500">({dept.km} km)</span>
                                      <span className="text-gray-700 font-medium sm:ml-auto">
                                        Bach√©: {rate.tarpsCost}‚Ç¨ | Plateau: {rate.flatbedCost}‚Ç¨
                                      </span>
                                    </li>
                                  );
                                })}
                              </ul>
                            )}
                          </div>
                        ))
                      )}
                    </div>
                  </>
                )}
              </div>

              {/* Itin√©raire Optimal */}
              {optimalRoute.length > 0 && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <div className="flex items-center gap-3 mb-4">
                    <MapPin className="text-blue-600" size={28} />
                    <h2 className="text-2xl font-bold text-gray-800">Itin√©raire Optimis√©</h2>
                  </div>
                  <div className="flex items-center gap-2 overflow-x-auto pb-2">
                    <div className="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">
                      üè≠ Sprimont
                    </div>
                    {optimalRoute.map((dept, index) => (
                      <React.Fragment key={dept.id}>
                        <div className="text-gray-400">‚Üí</div>
                        <div
                          className={`px-4 py-2 rounded-lg font-semibold whitespace-nowrap ${index === optimalRoute.length - 1 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`}
                        >
                          {index + 1}. {dept.name} ({dept.km}km)
                        </div>
                      </React.Fragment>
                    ))}
                  </div>
                  <p className="text-sm text-gray-600 mt-3">üí° Livraisons ordonn√©es du plus proche au plus √©loign√© pour minimiser les kilom√®tres</p>
                </div>
              )}

              {/* R√©sultats (affich√©s seulement apr√®s "Rechercher") */}
              {hasSearched && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <div className="flex items-center gap-3 mb-6">
                    <Calculator className="text-green-600" size={28} />
                    <h2 className="text-2xl font-bold text-gray-800">R√©sultats du Calcul</h2>
                  </div>

                  {!isBordereauValid || !truckType || selectedDepts.length === 0 ? (
                    <div className="flex items-center gap-3 text-amber-600 bg-amber-50 p-4 rounded-lg">
                      <AlertCircle />
                      <p>Veuillez renseigner tous les crit√®res obligatoires pour effectuer le calcul.</p>
                    </div>
                  ) : (
                    <>
                      {calculateBestTransporter.length === 0 ? (
                        <div className="text-gray-600">Aucun transporteur disponible.</div>
                      ) : (
                        <div className="space-y-4">
                          {calculateBestTransporter.map((result, index) => (
                            <div
                              key={result.transporter.id}
                              className={`p-6 rounded-lg border-2 ${index === 0 ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-200'}`}
                            >
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  {index === 0 && (
                                    <span className="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">‚≠ê MEILLEUR CHOIX</span>
                                  )}
                                  <h3 className="text-xl font-bold text-gray-800">{result.transporter.name}</h3>
                                  {result.transporter.hasBreakOfCharge && (
                                    <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Rupture de charge</span>
                                  )}
                                </div>
                                <div className="text-right">
                                  <div className="text-3xl font-bold text-indigo-600">{result.totalCost.toFixed(2)}‚Ç¨</div>
                                  <div className="text-sm text-gray-500">Co√ªt total</div>
                                </div>
                              </div>
                              <div className="space-y-1">
                                <p className="text-sm font-semibold text-gray-700 mb-2">D√©tail du calcul:</p>
                                {result.details.map((detail, i) => (
                                  <p key={i} className="text-sm text-gray-600 ml-4">‚Ä¢ {detail}</p>
                                ))}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}

              {/* Panneau tests */}
              <div className="bg-white rounded-xl shadow p-4 mb-8">
                <details>
                  <summary className="cursor-pointer text-sm text-gray-600">Diagnostics & auto-tests</summary>
                  <ul className="mt-2 text-sm list-disc ml-6">
                    {selfTests.map((t, i) => (
                      <li key={i} className={t.result ? 'text-green-700' : 'text-red-700'}>
                        {t.name} ‚Äî {t.result ? 'OK' : 'KO'} (attendu: {String(t.expected)}, obtenu: {String(t.got)})
                      </li>
                    ))}
                  </ul>
                </details>
              </div>

              {/* Footer */}
              <div className="text-center text-xs text-gray-500 mb-8">
                <p>
                  Format du bordereau : <code className="bg-gray-100 px-1 rounded">23/{currentYear}/####</code> ‚Äî Le type de camion influe sur les tarifs (Bach√© vs Plateau).
                </p>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TransportOptimizer />);
    </script>
  </body>
</html>
