<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Optimiseur de Transporteur</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Lucide React (UMD) -->
    <script src="https://unpkg.com/lucide-react@0.394.0/dist/lucide-react.umd.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Babel (pour ex√©cuter le JSX directement dans le navigateur) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      // ========= Correctifs de robustesse =========
      // 1) Lucide UMD peut ne pas exposer "lucideReact" selon la version/CDN.
      //    On prend la r√©f√©rence globale si dispo, sinon on fournit des composants vides pour √©viter les crashs.
      const LUCIDE_GLOBAL = (typeof window !== 'undefined' && (window.lucideReact || window.LucideReact)) || {};
      const NullIcon = (props) => null;
      const {
        Truck = NullIcon,
        Plus = NullIcon,
        Trash2 = NullIcon,
        Calculator = NullIcon,
        AlertCircle = NullIcon,
        MapPin = NullIcon,
        FileDown = NullIcon,
        Search = NullIcon,
      } = LUCIDE_GLOBAL;

      const { useState, useMemo, useEffect } = React;

      const SUPABASE_URL = 'https://eayhqksztfhyxqhrrnkk.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVheWhxa3N6dGZoeXhxaHJybmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTQwMzksImV4cCI6MjA3Nzc3MDAzOX0.AsWKSQDa9MDpsmvP6i4LOwBJevQfzUyImzt2_8D-o18';
      const supabaseClient =
        typeof window !== 'undefined' && window.supabase
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

      // --- Donn√©es de base ---
      const FRENCH_DEPARTMENTS = [
        { id: 1, code: '01', name: 'Ain', km: 620 },
        { id: 2, code: '02', name: 'Aisne', km: 240 },
        { id: 3, code: '03', name: 'Allier', km: 580 },
        { id: 4, code: '04', name: 'Alpes-de-Haute-Provence', km: 880 },
        { id: 5, code: '05', name: 'Hautes-Alpes', km: 850 },
        { id: 6, code: '06', name: 'Alpes-Maritimes', km: 1000 },
        { id: 7, code: '07', name: 'Ard√®che', km: 680 },
        { id: 8, code: '08', name: 'Ardennes', km: 120 },
        { id: 9, code: '09', name: 'Ari√®ge', km: 1100 },
        { id: 10, code: '10', name: 'Aube', km: 310 },
        { id: 11, code: '11', name: 'Aude', km: 1050 },
        { id: 12, code: '12', name: 'Aveyron', km: 900 },
        { id: 13, code: '13', name: 'Bouches-du-Rh√¥ne', km: 850 },
        { id: 14, code: '14', name: 'Calvados', km: 450 },
        { id: 15, code: '15', name: 'Cantal', km: 780 },
        { id: 16, code: '16', name: 'Charente', km: 720 },
        { id: 17, code: '17', name: 'Charente-Maritime', km: 780 },
        { id: 18, code: '18', name: 'Cher', km: 550 },
        { id: 19, code: '19', name: 'Corr√®ze', km: 740 },
        { id: 20, code: '2A', name: 'Corse-du-Sud', km: 1200 },
        { id: 21, code: '2B', name: 'Haute-Corse', km: 1180 },
        { id: 22, code: '21', name: "C√¥te-d'Or", km: 450 },
        { id: 23, code: '22', name: "C√¥tes-d'Armor", km: 680 },
        { id: 24, code: '23', name: 'Creuse', km: 700 },
        { id: 25, code: '24', name: 'Dordogne', km: 820 },
        { id: 26, code: '25', name: 'Doubs', km: 480 },
        { id: 27, code: '26', name: 'Dr√¥me', km: 720 },
        { id: 28, code: '27', name: 'Eure', km: 400 },
        { id: 29, code: '28', name: 'Eure-et-Loir', km: 450 },
        { id: 30, code: '29', name: 'Finist√®re', km: 850 },
        { id: 31, code: '30', name: 'Gard', km: 850 },
        { id: 32, code: '31', name: 'Haute-Garonne', km: 1050 },
        { id: 33, code: '32', name: 'Gers', km: 1000 },
        { id: 34, code: '33', name: 'Gironde', km: 900 },
        { id: 35, code: '34', name: 'H√©rault', km: 950 },
        { id: 36, code: '35', name: 'Ille-et-Vilaine', km: 620 },
        { id: 37, code: '36', name: 'Indre', km: 600 },
        { id: 38, code: '37', name: 'Indre-et-Loire', km: 550 },
        { id: 39, code: '38', name: 'Is√®re', km: 680 },
        { id: 40, code: '39', name: 'Jura', km: 520 },
        { id: 41, code: '40', name: 'Landes', km: 950 },
        { id: 42, code: '41', name: 'Loir-et-Cher', km: 500 },
        { id: 43, code: '42', name: 'Loire', km: 650 },
        { id: 44, code: '43', name: 'Haute-Loire', km: 720 },
        { id: 45, code: '44', name: 'Loire-Atlantique', km: 680 },
        { id: 46, code: '45', name: 'Loiret', km: 480 },
        { id: 47, code: '46', name: 'Lot', km: 880 },
        { id: 48, code: '47', name: 'Lot-et-Garonne', km: 900 },
        { id: 49, code: '48', name: 'Loz√®re', km: 850 },
        { id: 50, code: '49', name: 'Maine-et-Loire', km: 600 },
        { id: 51, code: '50', name: 'Manche', km: 550 },
        { id: 52, code: '51', name: 'Marne', km: 200 },
        { id: 53, code: '52', name: 'Haute-Marne', km: 350 },
        { id: 54, code: '53', name: 'Mayenne', km: 580 },
        { id: 55, code: '54', name: 'Meurthe-et-Moselle', km: 180 },
        { id: 56, code: '55', name: 'Meuse', km: 150 },
        { id: 57, code: '56', name: 'Morbihan', km: 750 },
        { id: 58, code: '57', name: 'Moselle', km: 200 },
        { id: 59, code: '58', name: 'Ni√®vre', km: 520 },
        { id: 60, code: '59', name: 'Nord', km: 180 },
        { id: 61, code: '60', name: 'Oise', km: 300 },
        { id: 62, code: '61', name: 'Orne', km: 500 },
        { id: 63, code: '62', name: 'Pas-de-Calais', km: 250 },
        { id: 64, code: '63', name: 'Puy-de-D√¥me', km: 680 },
        { id: 65, code: '64', name: 'Pyr√©n√©es-Atlantiques', km: 1100 },
        { id: 66, code: '65', name: 'Hautes-Pyr√©n√©es', km: 1080 },
        { id: 67, code: '66', name: 'Pyr√©n√©es-Orientales', km: 1150 },
        { id: 68, code: '67', name: 'Bas-Rhin', km: 350 },
        { id: 69, code: '68', name: 'Haut-Rhin', km: 420 },
        { id: 70, code: '69', name: 'Rh√¥ne', km: 620 },
        { id: 71, code: '70', name: 'Haute-Sa√¥ne', km: 430 },
        { id: 72, code: '71', name: 'Sa√¥ne-et-Loire', km: 520 },
        { id: 73, code: '72', name: 'Sarthe', km: 550 },
        { id: 74, code: '73', name: 'Savoie', km: 700 },
        { id: 75, code: '74', name: 'Haute-Savoie', km: 650 },
        { id: 76, code: '75', name: 'Paris', km: 320 },
        { id: 77, code: '76', name: 'Seine-Maritime', km: 400 },
        { id: 78, code: '77', name: 'Seine-et-Marne', km: 350 },
        { id: 79, code: '78', name: 'Yvelines', km: 350 },
        { id: 80, code: '79', name: 'Deux-S√®vres', km: 650 },
        { id: 81, code: '80', name: 'Somme', km: 280 },
        { id: 82, code: '81', name: 'Tarn', km: 1000 },
        { id: 83, code: '82', name: 'Tarn-et-Garonne', km: 950 },
        { id: 84, code: '83', name: 'Var', km: 950 },
        { id: 85, code: '84', name: 'Vaucluse', km: 800 },
        { id: 86, code: '85', name: 'Vend√©e', km: 700 },
        { id: 87, code: '86', name: 'Vienne', km: 630 },
        { id: 88, code: '87', name: 'Haute-Vienne', km: 700 },
        { id: 89, code: '88', name: 'Vosges', km: 300 },
        { id: 90, code: '89', name: 'Yonne', km: 420 },
        { id: 91, code: '90', name: 'Territoire de Belfort', km: 450 },
        { id: 92, code: '91', name: 'Essonne', km: 340 },
        { id: 93, code: '92', name: 'Hauts-de-Seine', km: 320 },
        { id: 94, code: '93', name: 'Seine-Saint-Denis', km: 330 },
        { id: 95, code: '94', name: 'Val-de-Marne', km: 340 },
        { id: 96, code: '95', name: "Val-d'Oise", km: 330 }
      ];

      // Calcul d'itin√©raire optimal (plus proche -> plus √©loign√©, en terminant par le plus loin)
      const calculateOptimalRoute = (selectedDeptIds, departments) => {
        if (selectedDeptIds.length === 0) return [];
        const selectedDepts = selectedDeptIds
          .map(id => departments.find(d => d.id === id))
          .filter(Boolean);
        if (selectedDepts.length === 1) return selectedDepts;
        const farthest = selectedDepts.reduce((max, dept) => (dept.km > max.km ? dept : max));
        const others = selectedDepts.filter(d => d.id !== farthest.id).sort((a, b) => a.km - b.km);
        return [...others, farthest];
      };

      // Helpers
      const currentYear = new Date().getFullYear();
      const BORDEREAU_REGEX = new RegExp(`^23\/${currentYear}\/([1-9]\d{0,3})$`);

      // Conversion CSV simple (corrig√©e: pas de saut de ligne dans le RegExp literal)
      function toCSV(rows) {
        if (!rows.length) return '';
        const headers = Object.keys(rows[0]);
        const escape = (v) => {
          if (v === null || v === undefined) return '';
          const s = String(v);
          if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
          return s;
        };
        const lines = [headers.join(',')];
        for (const row of rows) {
          lines.push(headers.map(h => escape(row[h])).join(','));
        }
        return lines.join('\n');
      }

      function downloadCSV(filename, rows) {
        const csv = toCSV(rows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function TransportOptimizer() {
        const [departments] = useState(FRENCH_DEPARTMENTS);

        // Deux types de camions: bach√© (tarps) et plateau (flatbed)
        const [truckType, setTruckType] = useState(''); // 'tarps' | 'flatbed'

        // Bordereau obligatoire
        const [bordereau, setBordereau] = useState('');
        const [bordereauTouched, setBordereauTouched] = useState(false);

        // Transporteurs avec deux tarifs par d√©partement
        const [transporters, setTransporters] = useState(() => {
          const t1 = {
            id: 1,
            name: 'Transport Express',
            hasBreakOfCharge: false,
            breakOfChargeCost: 0,
            rates: departments.map(d => ({
              deptId: d.id,
              tarpsCost: Math.round(d.km * 0.8), // bach√©
              flatbedCost: Math.round(d.km * 0.75) // plateau
            }))
          };
          const t2 = {
            id: 2,
            name: 'LogiFast',
            hasBreakOfCharge: true,
            breakOfChargeCost: 120,
            rates: departments.map(d => ({
              deptId: d.id,
              tarpsCost: Math.round(d.km * 0.85),
              flatbedCost: Math.round(d.km * 0.78)
            }))
          };
          return [t1, t2];
        });

        const [selectedDepts, setSelectedDepts] = useState([]);
        const [newTransporter, setNewTransporter] = useState({ name: '', breakOfChargeCost: '', hasBreakOfCharge: false });
        const [searchTerm, setSearchTerm] = useState('');
        const [hasSearched, setHasSearched] = useState(false);

        // Logs des recherches
        const [logs, setLogs] = useState([]);
        const [user, setUser] = useState(null);
        const [loginInput, setLoginInput] = useState('');
        const [password, setPassword] = useState('');
        const [authError, setAuthError] = useState('');
        const [authLoading, setAuthLoading] = useState(false);
        const [showRegistration, setShowRegistration] = useState(false);
        const [registerIdentifier, setRegisterIdentifier] = useState('');
        const [registerPassword, setRegisterPassword] = useState('');
        const [registerConfirmPassword, setRegisterConfirmPassword] = useState('');
        const [registerError, setRegisterError] = useState('');
        const [registerSuccess, setRegisterSuccess] = useState('');
        const [registerLoading, setRegisterLoading] = useState(false);

        const sanitizeIdentifier = (value) =>
          value
            .trim()
            .toLowerCase()
            .replace(/\s+/g, '.')
            .replace(/[^a-z0-9._-]/g, '');
        const identifierToEmail = (value) => {
          const cleaned = sanitizeIdentifier(value);
          return cleaned ? `${cleaned}@no-email.supabase.local` : '';
        };

        useEffect(() => {
          if (!supabaseClient) return;

          let isMounted = true;

          supabaseClient.auth.getSession().then(({ data }) => {
            if (!isMounted) return;
            setUser(data.session?.user ?? null);
          });

          const {
            data: { subscription }
          } = supabaseClient.auth.onAuthStateChange((_event, session) => {
            if (!isMounted) return;
            setUser(session?.user ?? null);
          });

          return () => {
            isMounted = false;
            subscription?.unsubscribe();
          };
        }, []);

        const normalizedUser = user
          ? (
              user.user_metadata?.identifiant ||
              (typeof user.email === 'string' ? user.email.split('@')[0] : '') ||
              ''
            ).toLowerCase()
          : '';
        const userDisplayName =
          user?.user_metadata?.identifiant ||
          user?.email ||
          'Utilisateur';
        const isAdmin = normalizedUser === 'admin.eloy';
        const canEditTransporters = isAdmin;
        const canViewLogs = isAdmin;

        const handleLogin = async (event) => {
          event.preventDefault();
          setAuthError('');
          setRegisterSuccess('');
          const identifier = sanitizeIdentifier(loginInput);

          if (!identifier || !password) {
            setAuthError('Veuillez saisir un identifiant et un mot de passe.');
            return;
          }

          if (!supabaseClient) {
            setAuthError('Client Supabase non initialis√©.');
            return;
          }

          setAuthLoading(true);
          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: identifierToEmail(identifier),
            password
          });

          if (error) {
            setAuthError(error.message);
          } else {
            setLoginInput('');
            setPassword('');
            setAuthError('');
            setUser(data?.user ?? null);
            setNewTransporter({ name: '', breakOfChargeCost: '', hasBreakOfCharge: false });
          }

          setAuthLoading(false);
        };

        const handleRegister = async (event) => {
          event.preventDefault();
          setRegisterError('');
          setRegisterSuccess('');

          const identifier = sanitizeIdentifier(registerIdentifier);

          if (!identifier || !registerPassword || !registerConfirmPassword) {
            setRegisterError('Veuillez renseigner un identifiant et un mot de passe.');
            return;
          }

          if (registerPassword !== registerConfirmPassword) {
            setRegisterError('La confirmation du mot de passe ne correspond pas.');
            return;
          }

          if (!supabaseClient) {
            setRegisterError('Client Supabase non initialis√©.');
            return;
          }

          setRegisterLoading(true);

          const { data, error } = await supabaseClient.auth.signUp({
            email: identifierToEmail(identifier),
            password: registerPassword,
            options: {
              data: {
                identifiant: identifier,
                identifiant_original: registerIdentifier.trim()
              }
            }
          });

          if (error) {
            setRegisterError(error.message);
          } else {
            setRegisterSuccess(
              'Utilisateur cr√©√© avec succ√®s. Vous pouvez maintenant vous connecter avec ces identifiants.'
            );
            setRegisterIdentifier('');
            setRegisterPassword('');
            setRegisterConfirmPassword('');
            setAuthError('');
            setShowRegistration(false);
            setLoginInput(identifier);
          }

          setRegisterLoading(false);
        };

        const handleLogout = async () => {
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          setUser(null);
          setLoginInput('');
          setPassword('');
          setAuthError('');
          setRegisterSuccess('');
          setNewTransporter({ name: '', breakOfChargeCost: '', hasBreakOfCharge: false });
        };

        const filteredDepartments = useMemo(() => {
          return departments.filter(d =>
            d.name.toLowerCase().includes(searchTerm.toLowerCase()) || d.code.includes(searchTerm)
          );
        }, [departments, searchTerm]);

        const optimalRoute = useMemo(() => calculateOptimalRoute(selectedDepts, departments), [selectedDepts, departments]);

        const calculateBestTransporter = useMemo(() => {
          if (selectedDepts.length === 0 || !truckType) return [];
          const route = optimalRoute;

          const results = transporters.map(transporter => {
            let totalCost = 0;
            const details = [];

            if (transporter.hasBreakOfCharge && route.length > 1) {
              totalCost += transporter.breakOfChargeCost;
              details.push(`Rupture de charge: ${transporter.breakOfChargeCost}‚Ç¨`);

              const farthestDept = route[route.length - 1];
              const farthestRate = transporter.rates.find(r => r.deptId === farthestDept.id);
              if (farthestRate) {
                const cost = truckType === 'tarps' ? farthestRate.tarpsCost : farthestRate.flatbedCost;
                totalCost += cost;
                details.push(`${farthestDept.name} (${farthestDept.km}km): ${cost}‚Ç¨`);
              }

              for (let i = 0; i < route.length - 1; i++) {
                const dept = route[i];
                const rate = transporter.rates.find(r => r.deptId === dept.id);
                if (rate) {
                  const base = truckType === 'tarps' ? rate.tarpsCost : rate.flatbedCost;
                  const adjustedCost = base * 0.7; // r√©duction apr√®s rupture
                  totalCost += adjustedCost;
                  details.push(`${dept.name} (depuis rupture): ${adjustedCost.toFixed(2)}‚Ç¨`);
                }
              }
            } else {
              route.forEach((dept, index) => {
                const rate = transporter.rates.find(r => r.deptId === dept.id);
                if (rate) {
                  const cost = truckType === 'tarps' ? rate.tarpsCost : rate.flatbedCost;
                  totalCost += cost;
                  details.push(`${index + 1}. ${dept.name} (${dept.km}km): ${cost}‚Ç¨`);
                }
              });
            }

            return { transporter, totalCost, details };
          });

          return results.sort((a, b) => a.totalCost - b.totalCost);
        }, [transporters, selectedDepts, optimalRoute, truckType]);

        // Actions Transporteurs
        const addTransporter = () => {
          if (!newTransporter.name) return;
          const id = Math.max(0, ...transporters.map(t => t.id)) + 1;
          setTransporters([
            ...transporters,
            {
              id,
              name: newTransporter.name,
              hasBreakOfCharge: newTransporter.hasBreakOfCharge,
              breakOfChargeCost: parseFloat(newTransporter.breakOfChargeCost) || 0,
              rates: departments.map(d => ({ deptId: d.id, tarpsCost: 0, flatbedCost: 0 }))
            }
          ]);
          setNewTransporter({ name: '', breakOfChargeCost: '', hasBreakOfCharge: false });
        };

        const removeTransporter = (id) => setTransporters(transporters.filter(t => t.id !== id));

        const updateTransporterRate = (transporterId, deptId, field, value) => {
          setTransporters(transporters.map(t => (
            t.id === transporterId
              ? {
                  ...t,
                  rates: t.rates.map(r => (
                    r.deptId === deptId
                      ? { ...r, [field]: parseFloat(value) || 0 }
                      : r
                  ))
                }
              : t
          )));
        };

        // Validation bordereau
        const isBordereauValid = BORDEREAU_REGEX.test(bordereau);

        // Recherche (calcul + log)
        const onSearch = () => {
          setBordereauTouched(true);
          if (!isBordereauValid || !truckType || selectedDepts.length === 0) return;
          setHasSearched(true);

          const sortedResults = calculateBestTransporter;
          const top3 = sortedResults.slice(0, 3);

          const logEntry = {
            date: new Date().toISOString(),
            bordereau,
            truckType: truckType === 'tarps' ? 'Bach√©' : 'Plateau',
            departments: selectedDepts
              .map(id => departments.find(d => d.id === id))
              .filter(Boolean)
              .map(d => `${d.code}-${d.name}`)
              .join(' | '),
            ranked_results: sortedResults
              .map((r, idx) => `${idx + 1}. ${r.transporter.name} (${r.totalCost.toFixed(2)}‚Ç¨)`) 
              .join(' | '),
            choice_1: top3[0] ? `${top3[0].transporter.name} (${top3[0].totalCost.toFixed(2)}‚Ç¨)` : '',
            choice_2: top3[1] ? `${top3[1].transporter.name} (${top3[1].totalCost.toFixed(2)}‚Ç¨)` : '',
            choice_3: top3[2] ? `${top3[2].transporter.name} (${top3[2].totalCost.toFixed(2)}‚Ç¨)` : ''
          };

          setLogs(prev => [logEntry, ...prev]);
        };

        // ================== Petit panneau de tests (auto-tests) ==================
        const [selfTests, setSelfTests] = useState([]);
        useEffect(() => {
          const tests = [];
          const YEAR = new Date().getFullYear();
          const ok = [];
          const ko = [];

          // Test bordereau (valide)
          const t1 = `23/${YEAR}/1`;
          ok.push({ name: 'Bordereau valide court', pass: BORDEREAU_REGEX.test(t1), expected: true, got: BORDEREAU_REGEX.test(t1) });

          const t2 = `23/${YEAR}/1234`;
          ok.push({ name: 'Bordereau valide 4 chiffres', pass: BORDEREAU_REGEX.test(t2), expected: true, got: BORDEREAU_REGEX.test(t2) });

          // Test bordereau (invalide)
          const t3 = `23/${YEAR}/12345`; // 5 chiffres => invalide
          ok.push({ name: 'Bordereau invalide 5 chiffres', pass: !BORDEREAU_REGEX.test(t3), expected: true, got: !BORDEREAU_REGEX.test(t3) });

          // Test itin√©raire: doit terminer par le plus √©loign√©
          const route = calculateOptimalRoute([8, 76], FRENCH_DEPARTMENTS); // Ardennes (120km) -> Paris (320km)
          const endsWithFarthest = route.length === 2 && route[1].code === '75';
          ok.push({ name: 'Itin√©raire termine par plus √©loign√©', pass: endsWithFarthest, expected: true, got: endsWithFarthest });

          // R√©sum√©
          const allPass = ok.every(t => t.pass);
          setSelfTests(ok.map(t => ({ name: t.name, result: t.pass, expected: t.expected, got: t.got })));
          console.log('[SelfTests]', { pass: allPass, details: ok });
        }, []);

        if (!user) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
              <div className="bg-white shadow-xl rounded-2xl p-8 w-full max-w-md">
                <div className="flex items-center gap-3 mb-6">
                  <Truck className="text-indigo-600" size={32} />
                  <div>
                    <h1 className="text-2xl font-bold text-gray-800">{showRegistration ? 'Cr√©er un utilisateur' : 'Connexion requise'}</h1>
                    <p className="text-sm text-gray-500">
                      {showRegistration
                        ? "D√©finissez un identifiant (sans email) et un mot de passe. Un email technique sera g√©n√©r√© automatiquement."
                        : "Connectez-vous avec l'identifiant et le mot de passe cr√©√©s pour Supabase."}
                    </p>
                  </div>
                </div>

                <div className="flex items-center justify-center gap-3 mb-6 text-sm">
                  <button
                    type="button"
                    onClick={() => {
                      setShowRegistration(false);
                      setRegisterError('');
                      setRegisterSuccess('');
                    }}
                    className={`px-3 py-1 rounded-full border ${
                      showRegistration ? 'border-gray-200 text-gray-500' : 'border-indigo-500 text-indigo-600 bg-indigo-50'
                    }`}
                  >
                    Se connecter
                  </button>
                  <button
                    type="button"
                    onClick={() => {
                      setShowRegistration(true);
                      setAuthError('');
                      setRegisterError('');
                      setRegisterSuccess('');
                    }}
                    className={`px-3 py-1 rounded-full border ${
                      showRegistration ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-gray-200 text-gray-500'
                    }`}
                  >
                    Cr√©er un utilisateur
                  </button>
                </div>

                {showRegistration ? (
                  <form onSubmit={handleRegister} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Identifiant</label>
                      <input
                        type="text"
                        value={registerIdentifier}
                        onChange={(e) => setRegisterIdentifier(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                        autoFocus
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                      <input
                        type="password"
                        value={registerPassword}
                        onChange={(e) => setRegisterPassword(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Confirmer le mot de passe</label>
                      <input
                        type="password"
                        value={registerConfirmPassword}
                        onChange={(e) => setRegisterConfirmPassword(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <p className="text-xs text-gray-500">
                      Un email interne du type <code>identifiant@no-email.supabase.local</code> sera utilis√© pour Supabase.
                      {identifierToEmail(registerIdentifier) && (
                        <span className="block mt-1">
                          Email g√©n√©r√© : <code>{identifierToEmail(registerIdentifier)}</code>
                        </span>
                      )}
                    </p>
                    {registerError && <p className="text-sm text-red-600">{registerError}</p>}
                    {registerSuccess && <p className="text-sm text-green-600">{registerSuccess}</p>}
                    <button
                      type="submit"
                      className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-60"
                      disabled={registerLoading}
                    >
                      {registerLoading ? 'Cr√©ation en cours...' : 'Cr√©er cet utilisateur'}
                    </button>
                  </form>
                ) : (
                  <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Identifiant</label>
                      <input
                        type="text"
                        value={loginInput}
                        onChange={(e) => setLoginInput(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                        autoFocus
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                      <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <p className="text-xs text-gray-500">
                      Utilisez l'identifiant d√©fini lors de la cr√©ation (sans ajouter d'email).
                    </p>
                    {registerSuccess && <p className="text-sm text-green-600">{registerSuccess}</p>}
                    {authError && <p className="text-sm text-red-600">{authError}</p>}
                    <button
                      type="submit"
                      className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-60"
                      disabled={authLoading}
                    >
                      {authLoading ? 'Connexion...' : 'Se connecter'}
                    </button>
                  </form>
                )}
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen p-8">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                  <div className="flex items-center gap-3">
                    <Truck className="text-indigo-600" size={32} />
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800">Optimiseur de Transporteur</h1>
                      <p className="text-sm text-gray-500">Depuis Eloywater SA, Sprimont, Belgique</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3 self-end md:self-auto">
                    <div className="text-sm text-gray-500">
                      Connect√© en tant que <span className="font-semibold text-gray-700">{userDisplayName}</span>
                      {!isAdmin && <span className="block text-xs text-amber-600">Mode lecture seule</span>}
                    </div>
                    <button
                      onClick={handleLogout}
                      className="px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-gray-50"
                    >
                      D√©connexion
                    </button>
                  </div>
                </div>
                <p className="text-gray-600 mt-6">Trouvez automatiquement le transporteur le moins cher avec itin√©raire optimis√©</p>
              </div>

              {/* Zone crit√®res & s√©lection */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                {/* Crit√®res globaux */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Crit√®res</h2>

                  {/* Bordereau */}
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bordereau <span className="text-red-600">*</span></label>
                  <input
                    type="text"
                    placeholder={`23/${currentYear}/####`}
                    value={bordereau}
                    onChange={(e) => setBordereau(e.target.value)}
                    onBlur={() => setBordereauTouched(true)}
                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 mb-2 ${
                      bordereauTouched && !isBordereauValid ? 'border-red-400 focus:ring-red-300' : 'focus:ring-indigo-500'
                    }`}
                  />
                  {bordereauTouched && !isBordereauValid && (
                    <div className="flex items-center gap-2 text-red-600 text-sm mb-4">
                      <AlertCircle size={16} />
                      <span>Format attendu : <code className="bg-red-50 px-1 rounded">23/{currentYear}/n</code> (n = 1 √† 4 chiffres).</span>
                    </div>
                  )}

                  {/* Type de camion */}
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type de camion <span className="text-red-600">*</span></label>
                  <div className="flex items-center gap-3 mb-4">
                    <label className={`px-3 py-2 border rounded-lg cursor-pointer ${truckType === 'tarps' ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}`}>
                      <input type="radio" name="truckType" value="tarps" className="mr-2" onChange={(e) => setTruckType(e.target.value)} checked={truckType==='tarps'} />
                      Bach√©
                    </label>
                    <label className={`px-3 py-2 border rounded-lg cursor-pointer ${truckType === 'flatbed' ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}`}>
                      <input type="radio" name="truckType" value="flatbed" className="mr-2" onChange={(e) => setTruckType(e.target.value)} checked={truckType==='flatbed'} />
                      Plateau
                    </label>
                  </div>

                  <button
                    onClick={onSearch}
                    className="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2"
                    disabled={!isBordereauValid || !truckType || selectedDepts.length === 0}
                    title={!isBordereauValid ? 'Bordereau requis' : (!truckType ? 'Type de camion requis' : (selectedDepts.length === 0 ? 'S√©lectionnez au moins un d√©partement' : 'Lancer la recherche'))}
                  >
                    <Search size={18} /> Rechercher
                  </button>

                  {(!isBordereauValid || !truckType || selectedDepts.length === 0) && (
                    <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2 mt-3">
                      Renseignez le bordereau, le type de camion et au moins un d√©partement pour activer la recherche.
                    </p>
                  )}
                </div>

                {/* S√©lection des D√©partements */}
                <div className="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">D√©partements √† livrer</h2>

                  <input
                    type="text"
                    placeholder="Rechercher (nom ou code)..."
                    className="w-full px-4 py-2 border rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />

                  <div className="mb-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                    <strong>S√©lectionn√©s:</strong> {selectedDepts.length} d√©partement(s)
                  </div>

                  <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto">
                    {filteredDepartments.map(dept => (
                      <div key={dept.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div className="flex items-center gap-3 flex-1">
                          <input
                            type="checkbox"
                            checked={selectedDepts.includes(dept.id)}
                            onChange={(e) => {
                              if (e.target.checked) setSelectedDepts([...selectedDepts, dept.id]);
                              else setSelectedDepts(selectedDepts.filter(id => id !== dept.id));
                            }}
                            className="w-4 h-4 text-indigo-600"
                          />
                          <span className="font-mono text-sm bg-indigo-100 px-2 py-1 rounded font-semibold">{dept.code}</span>
                          <span className="font-medium flex-1">{dept.name}</span>
                          <span className="text-sm text-gray-500 font-mono">{dept.km} km</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Gestion des Transporteurs */}
              <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Transporteurs</h2>

                <div className="mb-4 space-y-2">
                  {!canEditTransporters && (
                    <p className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
                      Les modifications transporteurs sont r√©serv√©es √† un administrateur.
                    </p>
                  )}
                  <input
                    type="text"
                    placeholder="Nom du transporteur"
                    className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${!canEditTransporters ? 'bg-gray-100 cursor-not-allowed opacity-75' : ''}`}
                    value={newTransporter.name}
                    onChange={(e) => setNewTransporter({ ...newTransporter, name: e.target.value })}
                    disabled={!canEditTransporters}
                  />
                  <div className="flex gap-2 flex-wrap items-center">
                    <div className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        id="hasBreak"
                        checked={newTransporter.hasBreakOfCharge}
                        onChange={(e) => setNewTransporter({ ...newTransporter, hasBreakOfCharge: e.target.checked })}
                        className="w-4 h-4 text-indigo-600"
                        disabled={!canEditTransporters}
                      />
                      <label htmlFor="hasBreak" className="text-sm">Rupture de charge</label>
                    </div>
                    {newTransporter.hasBreakOfCharge && (
                      <input
                        type="number"
                        placeholder="Co√ªt rupture"
                        className={`px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 ${!canEditTransporters ? 'bg-gray-100 cursor-not-allowed opacity-75' : ''}`}
                        value={newTransporter.breakOfChargeCost}
                        onChange={(e) => setNewTransporter({ ...newTransporter, breakOfChargeCost: e.target.value })}
                        disabled={!canEditTransporters}
                      />
                    )}
                    <button
                      onClick={() => canEditTransporters && addTransporter()}
                      className={`px-4 py-2 rounded-lg flex items-center gap-2 ${canEditTransporters ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`}
                      disabled={!canEditTransporters}
                      title={canEditTransporters ? 'Ajouter un transporteur' : 'Acc√®s r√©serv√© √† un administrateur'}
                    >
                      <Plus size={20} /> Ajouter
                    </button>
                  </div>
                </div>

                <div className="space-y-4 max-h-[30rem] overflow-y-auto">
                  {transporters.map(transporter => (
                    <div key={transporter.id} className="border rounded-lg p-4">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <h3 className="font-bold text-gray-800">{transporter.name}</h3>
                          {transporter.hasBreakOfCharge && (
                            <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">
                              Rupture: {transporter.breakOfChargeCost}‚Ç¨
                            </span>
                          )}
                        </div>
                        <button
                          onClick={() => canEditTransporters && removeTransporter(transporter.id)}
                          className={`p-1 rounded ${canEditTransporters ? 'text-red-600 hover:bg-red-50' : 'text-gray-400 cursor-not-allowed'}`}
                          disabled={!canEditTransporters}
                          title={canEditTransporters ? 'Supprimer le transporteur' : 'Acc√®s r√©serv√© √† un administrateur'}
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                      <details className="text-sm">
                        <summary className="cursor-pointer text-indigo-600 hover:text-indigo-800 mb-2">
                          Modifier les tarifs par d√©partement (Bach√© / Plateau)
                        </summary>
                        {!canEditTransporters && (
                          <p className="text-xs text-amber-600 mb-2">Consultation uniquement.</p>
                        )}
                        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-3 max-h-64 overflow-y-auto">
                          {departments.map(dept => {
                            const rate = transporter.rates.find(r => r.deptId === dept.id) || { tarpsCost: 0, flatbedCost: 0 };
                            return (
                              <div key={dept.id} className="border rounded p-2">
                                <div className="text-xs font-semibold mb-1 truncate">{dept.code} - {dept.name}</div>
                                <div className="flex items-center gap-2 mb-1">
                                  <span className="text-xs w-14">Bach√©</span>
                                  <input
                                    type="number"
                                    placeholder="‚Ç¨"
                                    className={`flex-1 px-2 py-1 border rounded text-sm ${!canEditTransporters ? 'bg-gray-100 cursor-not-allowed opacity-75' : ''}`}
                                    value={rate.tarpsCost}
                                    onChange={(e) => updateTransporterRate(transporter.id, dept.id, 'tarpsCost', e.target.value)}
                                    disabled={!canEditTransporters}
                                  />
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-xs w-14">Plateau</span>
                                  <input
                                    type="number"
                                    placeholder="‚Ç¨"
                                    className={`flex-1 px-2 py-1 border rounded text-sm ${!canEditTransporters ? 'bg-gray-100 cursor-not-allowed opacity-75' : ''}`}
                                    value={rate.flatbedCost}
                                    onChange={(e) => updateTransporterRate(transporter.id, dept.id, 'flatbedCost', e.target.value)}
                                    disabled={!canEditTransporters}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </details>
                    </div>
                  ))}
                </div>
              </div>

              {/* Itin√©raire Optimal */}
              {optimalRoute.length > 0 && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <div className="flex items-center gap-3 mb-4">
                    <MapPin className="text-blue-600" size={28} />
                    <h2 className="text-2xl font-bold text-gray-800">Itin√©raire Optimis√©</h2>
                  </div>
                  <div className="flex items-center gap-2 overflow-x-auto pb-2">
                    <div className="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">
                      üè≠ Sprimont
                    </div>
                    {optimalRoute.map((dept, index) => (
                      <React.Fragment key={dept.id}>
                        <div className="text-gray-400">‚Üí</div>
                        <div
                          className={`px-4 py-2 rounded-lg font-semibold whitespace-nowrap ${index === optimalRoute.length - 1 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`}
                        >
                          {index + 1}. {dept.name} ({dept.km}km)
                        </div>
                      </React.Fragment>
                    ))}
                  </div>
                  <p className="text-sm text-gray-600 mt-3">üí° Livraisons ordonn√©es du plus proche au plus √©loign√© pour minimiser les kilom√®tres</p>
                </div>
              )}

              {/* R√©sultats (affich√©s seulement apr√®s "Rechercher") */}
              {hasSearched && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <div className="flex items-center gap-3 mb-6">
                    <Calculator className="text-green-600" size={28} />
                    <h2 className="text-2xl font-bold text-gray-800">R√©sultats du Calcul</h2>
                  </div>

                  {!isBordereauValid || !truckType || selectedDepts.length === 0 ? (
                    <div className="flex items-center gap-3 text-amber-600 bg-amber-50 p-4 rounded-lg">
                      <AlertCircle />
                      <p>Veuillez renseigner tous les crit√®res obligatoires pour effectuer le calcul.</p>
                    </div>
                  ) : (
                    <>
                      {calculateBestTransporter.length === 0 ? (
                        <div className="text-gray-600">Aucun transporteur disponible.</div>
                      ) : (
                        <div className="space-y-4">
                          {calculateBestTransporter.map((result, index) => (
                            <div
                              key={result.transporter.id}
                              className={`p-6 rounded-lg border-2 ${index === 0 ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-200'}`}
                            >
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  {index === 0 && (
                                    <span className="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">‚≠ê MEILLEUR CHOIX</span>
                                  )}
                                  <h3 className="text-xl font-bold text-gray-800">{result.transporter.name}</h3>
                                  {result.transporter.hasBreakOfCharge && (
                                    <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Rupture de charge</span>
                                  )}
                                </div>
                                <div className="text-right">
                                  <div className="text-3xl font-bold text-indigo-600">{result.totalCost.toFixed(2)}‚Ç¨</div>
                                  <div className="text-sm text-gray-500">Co√ªt total</div>
                                </div>
                              </div>
                              <div className="space-y-1">
                                <p className="text-sm font-semibold text-gray-700 mb-2">D√©tail du calcul:</p>
                                {result.details.map((detail, i) => (
                                  <p key={i} className="text-sm text-gray-600 ml-4">‚Ä¢ {detail}</p>
                                ))}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}

              {canViewLogs && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold text-gray-800">Historique des recherches</h2>
                    <button
                      onClick={() => downloadCSV('recherches_transport.csv', logs)}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50"
                      disabled={logs.length === 0}
                      title={logs.length === 0 ? 'Aucune entr√©e √† exporter' : 'T√©l√©charger en CSV'}
                    >
                      <FileDown size={18} /> T√©l√©charger CSV
                    </button>
                  </div>

                  {logs.length === 0 ? (
                    <p className="text-gray-500">Aucune recherche encore. Lancez une recherche pour enregistrer un log.</p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full text-sm">
                        <thead>
                          <tr className="text-left text-gray-600 border-b">
                            <th className="py-2 pr-4">Date (ISO)</th>
                            <th className="py-2 pr-4">Bordereau</th>
                            <th className="py-2 pr-4">Type camion</th>
                            <th className="py-2 pr-4">D√©partements</th>
                            <th className="py-2 pr-4">R√©sultat class√©</th>
                            <th className="py-2 pr-4">Choix #1</th>
                            <th className="py-2 pr-4">Choix #2</th>
                            <th className="py-2 pr-4">Choix #3</th>
                          </tr>
                        </thead>
                        <tbody>
                          {logs.map((log, idx) => (
                            <tr key={idx} className="border-b align-top">
                              <td className="py-2 pr-4 whitespace-nowrap">{log.date}</td>
                              <td className="py-2 pr-4">{log.bordereau}</td>
                              <td className="py-2 pr-4">{log.truckType}</td>
                              <td className="py-2 pr-4">{log.departments}</td>
                              <td className="py-2 pr-4">{log.ranked_results}</td>
                              <td className="py-2 pr-4">{log.choice_1}</td>
                              <td className="py-2 pr-4">{log.choice_2}</td>
                              <td className="py-2 pr-4">{log.choice_3}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}

              {/* Panneau tests */}
              <div className="bg-white rounded-xl shadow p-4 mb-8">
                <details>
                  <summary className="cursor-pointer text-sm text-gray-600">Diagnostics & auto-tests</summary>
                  <ul className="mt-2 text-sm list-disc ml-6">
                    {selfTests.map((t, i) => (
                      <li key={i} className={t.result ? 'text-green-700' : 'text-red-700'}>
                        {t.name} ‚Äî {t.result ? 'OK' : 'KO'} (attendu: {String(t.expected)}, obtenu: {String(t.got)})
                      </li>
                    ))}
                  </ul>
                </details>
              </div>

              {/* Footer */}
              <div className="text-center text-xs text-gray-500 mb-8">
                <p>
                  Format du bordereau : <code className="bg-gray-100 px-1 rounded">23/{currentYear}/####</code> ‚Äî Le type de camion influe sur les tarifs (Bach√© vs Plateau).
                </p>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TransportOptimizer />);
    </script>
  </body>
</html>
